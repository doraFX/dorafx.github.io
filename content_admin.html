<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>ä¼é¹…ä¼ä¼å†…å®¹ç®¡ç†</title>

		<!-- æ ¸å¿ƒåº“ -->
		<script src="js/vue.global.js"></script>
		<script src="js/tailwindcss.3.4.17.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">

		<!-- Editor.js æ ¸å¿ƒ -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>

		<!-- === å¸¸ç”¨æ ¼å¼æ’ä»¶ === -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/nested-list@latest"></script>
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@latest"></script>
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script> <!-- ç”¨äº YouTube/Bç«™ -->

		<!-- === æ–°å¢ï¼šæ›´å¤šå¯Œæ–‡æœ¬æ’ä»¶ === -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script> <!-- è¡¨æ ¼ -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script> <!-- å¾…åŠæ¸…å• -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script> <!-- é»„è‰²é«˜äº® -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script> <!-- è¡Œå†…ä»£ç  -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/underline@latest"></script> <!-- ä¸‹åˆ’çº¿ -->

		<!-- === å›¾ç‰‡ä¸è§†é¢‘ä¸Šä¼  === -->
		<script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
		<!-- è§†é¢‘ä¸Šä¼ æ’ä»¶ (ç¤¾åŒºç‰ˆï¼Œæ”¯æŒ HTML5 Video) -->
		<script src="https://cdn.jsdelivr.net/npm/@weekwood/editorjs-video@latest"></script>

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link
			href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Noto+Sans+KR:wght@100..900&family=Noto+Sans+SC:wght@100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
			rel="stylesheet">

		<link rel="stylesheet" href="css/style.css" />

		<link rel="stylesheet" href="css/apple-video-player.css" />
		<script src="js/apple-video-player.js"></script>
		<script>
			AppleTVLikePlayer.auto();
		</script>

		<script>
			tailwind.config = {
				darkMode: 'class',
				theme: {
					extend: {
						fontFamily: {
							sans: [
								'Noto Sans SC', 'Noto Sans JP', 'Noto Sans KR', 'Noto Sans', 'sans-serif',
							],
						},
						colors: {
							primary: {
								50: '#f0f9ff',
								100: '#e0f2fe',
								200: '#bae6fd',
								300: '#7dd3fc',
								400: '#38bdf8',
								500: '#0ea5e9',
								600: '#0284c7',
								700: '#0369a1',
								800: '#075985',
								900: '#0c4a6e',
							}
						}
					}
				}
			}
		</script>

		<style>
			/* =========================================
		       1. å…¨å±€å˜é‡ä¸åŸºç¡€è®¾ç½® (Apple Style)
		       ========================================= */
			:root {
				--apple-bg: #f5f5f7;
				--apple-card: rgba(255, 255, 255, .72);
				--apple-border: rgba(60, 60, 67, .14);
				--apple-border-strong: rgba(60, 60, 67, .22);
				--apple-text: #1d1d1f;
				--apple-sub: rgba(29, 29, 31, .62);
				--apple-blue: #0A84FF;
				--apple-shadow: 0 10px 30px rgba(0, 0, 0, .08);
				--apple-shadow-soft: 0 6px 18px rgba(0, 0, 0, .06);
			}

			/* ç»Ÿä¸€å¡ç‰‡æ¯›ç»ç’ƒæ„Ÿ */
			.apple-card {
				background: var(--apple-card);
				border: 1px solid var(--apple-border);
				backdrop-filter: blur(14px);
				-webkit-backdrop-filter: blur(14px);
				box-shadow: var(--apple-shadow-soft);
				border-radius: 18px;
			}

			/* æ›´â€œè‹¹æœâ€çš„è¾“å…¥/é€‰æ‹©æ¡† */
			.apple-input {
				background: rgba(255, 255, 255, .8);
				border: 1px solid var(--apple-border);
				border-radius: 12px;
			}

			.apple-input:focus {
				outline: none;
				border-color: rgba(10, 132, 255, .55);
				box-shadow: 0 0 0 4px rgba(10, 132, 255, .16);
			}

			/* =========================================
		       2. é®ç½©å±‚åŠ¨ç”» (åˆå¹¶ä¼˜åŒ–ç‰ˆ)
		       ========================================= */
			.modal-enter-active,
			.modal-leave-active {
				transition: all 0.25s ease-out;
			}

			.modal-enter-from,
			.modal-leave-to {
				opacity: 0;
				transform: scale(0.98);
			}

			/* =========================================
		       3. Editor.js æ ¸å¿ƒä¿®å¤ä¸ç¾åŒ–
		       ========================================= */

			/* å®¹å™¨æ ·å¼ (A4çº¸å¼ æ„Ÿ) */
			.editor-paper {
				background: white;
				min-height: 800px;
				padding: 60px 80px;
				/* å®½æ•å†…è¾¹è·ï¼Œä¸ºå·¦ä¾§å·¥å…·æ ç•™å‡ºç©ºé—´ */
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
				border-radius: 8px;
				margin: 0 auto;
				max-width: 850px;
				box-sizing: border-box;
			}

			/* ä¿®å¤ Editor.js é»˜è®¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œä½¿å…¶å¡«æ»¡ editor-paper */
			.ce-block__content,
			.ce-toolbar__content {
				max-width: 100% !important;
				margin: 0 auto !important;
			}

			/* ä¿®å¤ç¼–è¾‘åŒºåŸŸåº•éƒ¨é—´è·ï¼Œé˜²æ­¢æœ€åä¸€è¡Œè¢«é®æŒ¡ */
			.codex-editor__redactor {
				padding-bottom: 100px !important;
				margin-right: 0 !important;
				/* ä¿®å¤å³ä¾§æº¢å‡º */
			}

			/* ä¿®å¤å·¥å…·æ (åŠ å·/è®¾ç½®)ä½ç½®ï¼Œåˆ©ç”¨ padding ç•™å‡ºçš„ç©ºé—´ */
			.ce-toolbar__actions {
				left: -76px;
				/* è°ƒæ•´å·¥å…·æ æŒ‰é’®ä½ç½®ï¼Œä½¿å…¶ä½äº padding åŒºåŸŸå†… */
				right: auto;
			}

			/* æå‡å·¥å…·æ å±‚çº§ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
			.ce-toolbar,
			.ce-popover,
			.ce-inline-toolbar,
			.ce-settings,
			.codex-editor-overlay {
				z-index: 9999 !important;
			}

			@media (max-width: 600px) {
				.ce-toolbar {
					margin-left: 44px;
				}

				.ce-toolbar__actions {
					left: -40px;
				}
			}

			/* æ ‡é¢˜æ ·å¼ */
			.ce-header {
				font-weight: 700;
			}

			h1.ce-header {
				font-size: 2.25em;
			}

			h2.ce-header {
				font-size: 1.75em;
			}

			h3.ce-header {
				font-size: 1.35em;
			}

			/* æ­£æ–‡æ ·å¼ */
			.ce-paragraph {
				font-size: 16px;
				line-height: 1.8;
				color: #37352f;
			}

			/* å›¾ç‰‡å±…ä¸­ä¸åœ†è§’ */
			.image-tool__image-picture {
				margin: 0 auto;
				border-radius: 8px;
				display: block;
			}

			/* =========================================
		       5. ä¾§è¾¹æ ä¸å¯¼èˆª
		       ========================================= */
			.nav-item {
				transition: all 0.2s;
			}

			.nav-item:hover:not(.nav-item-active) {
				background-color: #d3dde6;
			}

			.nav-item-active {
				background-color: #d3dde6;
				color: rgb(51 65 85 / var(--tw-bg-opacity, 1));
				font-weight: 600;
			}


			/* ===== Editor.jsï¼šä»¿é£ä¹¦çš„ Block hover & Media padding ===== */

			/* 1. è®©æ¯ä¸ª block éƒ½æœ‰â€œå®¹å™¨æ„Ÿâ€ */
			#editorjs .ce-block {
				border-radius: 12px;
				transition: background-color 0.1s ease;
				border: 1px solid transparent;
				/* é¢„ç•™è¾¹æ¡†ä½ç½®é˜²æ­¢æŠ–åŠ¨ */
				margin: 4px 0;
				/* å—ä¸å—ä¹‹é—´çš„é—´è· */
				transition: all 0.25s ease-in-out;
			}

			/* 2. å®ç°ä½ æƒ³è¦çš„ Hover æ•ˆæœ (å¯¹åº” hover-bg-b5) */
			/* åªæœ‰å½“é¼ æ ‡æ‚¬åœåœ¨å—å†…ï¼Œä¸”ä¸æ˜¯æ­£åœ¨è¾“å…¥æ–‡å­—çš„çŠ¶æ€æ—¶æ˜¾ç¤ºèƒŒæ™¯ */
			#editorjs .ce-block:hover {
				background-color: rgba(0, 0, 0, 0.04);
			}

			/* 3. ã€å…³é”®ä¿®å¤ã€‘ç»™å†…å®¹åŠ å®½æ•çš„å†…è¾¹è· */
			/* è¿™é‡Œçš„ 40px å°±æ˜¯ä½ çš„â€œç‚¹å‡»æŠŠæ‰‹â€ï¼Œç‚¹å‡»è§†é¢‘æ—è¾¹çš„è¿™ä¸ªåŒºåŸŸå³å¯é€‰ä¸­è§†é¢‘å— */
			#editorjs .ce-block__content {
				padding: 0px 14px !important;
				max-width: 100% !important;
				box-sizing: border-box;
				transition: all 0.25s ease-in-out;
			}

			#editorjs .ce-block:hover .ce-block__content {
				padding: 0px 14px !important;
			}

			#editorjs .ce-block:hover .ce-paragraph {
				color: #000000;
				transition: all 0.25s;
			}

			/* ä¿®å¤ Video å·¥å…·é»˜è®¤æ ·å¼å¯èƒ½å¯¼è‡´çš„ç‚¹å‡»ç©¿é€é—®é¢˜ */
			.video-tool__video video {
				display: block;
				width: 100%;
			}

			.video-tool__video>div {
				width: 100% !important;
				height: 100% !important;
			}





			/* ===============================
			   Media Control (Image / Video)
			   é£ä¹¦ / Notion é£æ ¼
			================================ */

			/* 1ï¸âƒ£ å®¹å™¨ï¼šé»˜è®¤éšè—ï¼Œhover block æ˜¾ç¤º */
			.ce-block .media-ctrl {
				margin-top: 10px;
				padding: 10px 12px;
				border-radius: 10px;
				background: rgba(245, 246, 247, 0.95);
				border: 1px solid rgba(0, 0, 0, 0.06);
				display: flex;
				align-items: center;
				gap: 8px;
				flex-wrap: wrap;

				font-size: 12px;
				color: #444;

				opacity: 0.75;
				pointer-events: none;

				transition:
					opacity .25s ease,
					transform .25s ease;
			}

			/* 2ï¸âƒ£ hover block æ—¶æ˜¾ç¤ºï¼ˆå…³é”®ï¼‰ */
			.ce-block:hover .media-ctrl,
			.ce-block.ce-block--focused .media-ctrl,
			.ce-block.ce-block--selected .media-ctrl {
				opacity: 1;
				pointer-events: auto;
			}

			/* 3ï¸âƒ£ URL è¾“å…¥æ¡† */
			.media-ctrl__input {
				flex: 1;
				min-width: 200px;

				height: 30px;
				padding: 0 10px;

				font-size: 12px;
				border-radius: 6px;
				border: 1px solid rgba(0, 0, 0, 0.12);
				background: #fff;
				color: #222;

				outline: none;
			}

			.media-ctrl__input:focus {
				border-color: rgb(65, 79, 99);
				;
				box-shadow: 0 0 0 2px rgba(79, 70, 229, .15);
			}

			/* 4ï¸âƒ£ æŒ‰é’®ç»Ÿä¸€é£æ ¼ */
			.media-ctrl__btn {
				height: 30px;
				padding: 0 10px;

				font-size: 12px;
				font-weight: 500;

				border-radius: 6px;
				border: 1px solid rgba(0, 0, 0, 0.12);
				background: #fff;
				color: #333;

				cursor: pointer;
				white-space: nowrap;

				transition:
					background .15s ease,
					border-color .15s ease,
					color .15s ease;
			}

			.media-ctrl__btn:hover {
				background: #f3f4f6;
			}

			/* 5ï¸âƒ£ ä¸»æ“ä½œæŒ‰é’®ï¼ˆåº”ç”¨ URLï¼‰ */
			.media-ctrl__apply {
				background: #eef2ff;
				border-color: rgba(79, 70, 229, .25);
				color: rgb(65, 79, 99);
				;
			}

			.media-ctrl__apply:hover {
				background: #e0e7ff;
			}

			/* 6ï¸âƒ£ ä¸Šä¼ æŒ‰é’®ï¼ˆæ¬¡çº§ï¼‰ */
			.media-ctrl__upload {
				background: #f8fafc;
			}

			.media-ctrl__upload:hover {
				background: #e5e7eb;
			}

			/* 7ï¸âƒ£ æç¤ºæ–‡å­— */
			.media-ctrl__hint {
				font-size: 11px;
				color: #888;
				margin-left: auto;
				white-space: nowrap;
			}

			/* 8ï¸âƒ£ ç§»åŠ¨ç«¯ç¨å¾®ç´§å‡‘ */
			@media (max-width: 640px) {
				.media-ctrl {
					padding: 8px;
					gap: 6px;
				}

				.media-ctrl__hint {
					display: none;
				}
			}




			.video-progress {
				margin-top: 10px;
				display: none;
				align-items: center;
				gap: 10px;
				width: 100%;
			}

			.video-progress__bar {
				flex: 1;
				height: 6px;
				border-radius: 999px;
				background: rgba(0, 0, 0, .10);
				overflow: hidden;
			}

			.video-progress__fill {
				height: 100%;
				width: 0%;
				background: rgba(79, 70, 229, .85);
			}

			.video-progress__pct {
				font-size: 11px;
				color: #666;
				min-width: 42px;
				text-align: right;
			}





			/* å…¶ä»– */

			.video-tool {
				border: none;
			}

			.video-tool__video {
				display: flex;
				justify-content: center;
				border: none !important;
			}



			.hover-bg-b5 {
				transition: background-color 0.2s ease;
			}

			.hover-bg-b5:hover {
				background-color: rgba(0, 0, 0, 0.05);
				color: rgba(0, 0, 0, 0.8);
			}

			.cdx-block .cdx-input {
				/* display: none; */
				margin: 0;
				padding: 0;
				opacity: 1;
				position: relative;
				border-radius: 10px;
				font-size: 18px;
				transition: all 0.25s ease-in-out;
				display: flex;
				align-items: center;
				padding-left: 10px;
			}

			.cdx-input {
				height: 44px;
			}

			#editorjs .ce-block:hover .cdx-input {
				height: 44px;
				opacity: 1;
				font-size: 18px;
				line-height: 44px;
			}

			.image-tool--caption {
				padding-bottom: 12px;
				padding-top: 12px;
			}
		</style>
	</head>
	<body class="bg-slate-100 text-slate-800">
		<div id="app" class="h-screen flex overflow-hidden bg-[#f5f6f7]">

			<!-- 1. å·¦ä¾§ä¾§è¾¹æ  (å·¥å…·å¯¼èˆª) + ç§»åŠ¨ç«¯åº•éƒ¨ Tab -->
			<!-- Desktop Sidebar (>= md) -->
			<aside v-if="session" class="hidden md:flex w-64 bg-white border-r border-slate-200 flex-col z-20 shrink-0">
				<div class="h-28 flex flex-col items-center justify-center gap-3 px-6 border-b border-slate-100">
					<div class="w-8 h-8">
						<img src="images/logo.webp" class="w-full h-full rounded" alt="" />
					</div>
					<h1 class="font-bold text-lg tracking-tight text-slate-800">ä¼é¹…ä¼ä¼å†…å®¹ç®¡ç†</h1>
				</div>

				<nav class="flex-1 p-4 space-y-2 overflow-y-auto">
					<div class="px-2 py-2 text-xs font-bold text-slate-400 uppercase">å†…å®¹ç®¡ç†</div>
					<button @click="switchTab('blog')"
						:class="['nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentTab === 'blog' ? 'nav-item-active' : 'text-slate-600']">
						æ–‡ç« 
					</button>
					<button @click="switchTab('media')"
						:class="['nav-item w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm', currentTab === 'media' ? 'nav-item-active' : 'text-slate-600']">
						ä½œå“
					</button>
				</nav>

				<div class="p-4 border-t border-slate-100">
					<div class="flex items-center gap-3 px-4 py-3 rounded-lg bg-slate-50 mb-2">
						<div
							class="w-8 h-8 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center font-bold text-xs">
							{{ session.user.email[0].toUpperCase() }}
						</div>
						<div class="flex-1 min-w-0">
							<p class="text-xs font-medium text-slate-900 truncate">{{ session.user.email }}</p>
						</div>
					</div>
					<button @click="logout"
						class="w-full py-2 text-xs font-medium text-red-500 hover:bg-red-50 rounded-lg transition-colors">
						é€€å‡ºç™»å½•
					</button>
				</div>
			</aside>

			<!-- Mobile Bottom Tab Bar (< md) -->
			<div v-if="session"
				class="md:hidden fixed bottom-0 left-0 right-0 z-40 bg-white border-t border-slate-200 pb-[env(safe-area-inset-bottom)]">
				<div class="grid grid-cols-2">
					<button @click="switchTab('blog')"
						:class="['py-3 text-sm font-semibold transition-colors', currentTab==='blog' ? 'text-slate-600' : 'text-slate-500']">
						æ–‡ç« 
					</button>
					<button @click="switchTab('media')"
						:class="['py-3 text-sm font-semibold transition-colors', currentTab==='media' ? 'text-slate-600' : 'text-slate-500']">
						ä½œå“
					</button>
				</div>
			</div>

			<!-- 2. ç™»å½•ç•Œé¢ (æœªç™»å½•æ—¶å…¨å±) -->
			<div v-if="!session" class="fixed inset-0 z-50 bg-slate-100 flex items-center justify-center p-4">
				<div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-200">
					<h2 class="text-2xl font-bold mb-6 text-center text-slate-800">ç®¡ç†å‘˜ç™»å½•</h2>
					<div class="space-y-4">
						<div>
							<label class="block text-sm font-medium mb-1 text-slate-600">é‚®ç®±</label>
							<input v-model="email" type="email"
								class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 outline-none transition-all">
						</div>
						<div>
							<label class="block text-sm font-medium mb-1 text-slate-600">å¯†ç </label>
							<input v-model="password" type="password"
								class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 outline-none transition-all">
						</div>
						<button @click="login" :disabled="loading"
							class="w-full py-3 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium transition-all disabled:opacity-50 shadow-lg shadow-slate-200">
							{{ loading ? 'ç™»å½•ä¸­...' : 'è¿›å…¥åå°' }}
						</button>
						<p v-if="msg" class="text-red-500 text-sm text-center mt-2">{{ msg }}</p>
					</div>
				</div>
			</div>

			<!-- 3. ä¸»åˆ—è¡¨åŒº -->
			<main v-else class="flex-1 flex flex-col min-w-0 overflow-hidden bg-white/50">
				<!-- é¡¶éƒ¨å·¥å…·æ  -->
				<header
					class="h-auto md:h-16 bg-white border-b border-slate-200 flex flex-col md:flex-row md:items-center md:justify-between px-4 md:px-8 py-3 md:py-0 sticky top-0 z-10 gap-3">
					<h2 class="text-lg md:text-xl font-bold text-slate-800 leading-tight">
						{{ currentTab === 'blog' ? 'æ–‡ç« åˆ—è¡¨' : 'ä½œå“åˆ—è¡¨' }}
					</h2>

					<div class="flex gap-2 md:gap-3 w-full md:w-auto">
						<button @click="fetchList(true)"
							class="flex-1 md:flex-none px-3 md:px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 text-xs md:text-sm font-medium transition-all">
							åˆ·æ–°
						</button>
						<button @click="openEditModal(null)"
							class="flex-1 md:flex-none px-3 md:px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 shadow-md shadow-slate-200 text-xs md:text-sm font-medium flex items-center justify-center gap-2 transition-all">
							<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M12 4v16m8-8H4"></path>
							</svg>
							<span>æ–°å¢</span>
						</button>
					</div>
				</header>

				<!-- åˆ—è¡¨å†…å®¹ -->
				<div class="flex-1 overflow-auto p-4 md:p-8 pb-24 md:pb-8">
					<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">

						<!-- ===== Mobile Cards (< md) ===== -->
						<div class="md:hidden divide-y divide-slate-100">
							<div v-for="item in displayList" :key="item.id" class="p-4 active:bg-slate-50">
								<div class="flex gap-3">
									<div
										class="w-20 h-14 bg-slate-100 rounded-lg border border-slate-200 overflow-hidden shrink-0">
										<img v-if="currentTab==='blog' ? item.cover : item.thumbnail"
											:src="currentTab==='blog' ? item.cover : item.thumbnail"
											class="w-full h-full object-cover">
										<div v-else
											class="w-full h-full flex items-center justify-center text-slate-300 text-xs">
											æ— å›¾</div>
									</div>

									<div class="flex-1 min-w-0">
										<div class="flex items-start justify-between gap-2">
											<div class="font-semibold text-slate-900 text-sm leading-snug line-clamp-2">
												{{ getI18n(item.title, 'zh') || '(æœªå‘½å)' }}
											</div>
											<span
												:class="['shrink-0 px-2 py-0.5 rounded-full text-[11px] font-bold border',
													item.published ? 'bg-green-50 text-green-700 border-green-100' : 'bg-slate-100 text-slate-500 border-slate-200']">
												{{ item.published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿' }}
											</span>
										</div>

										<div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-500">
											<!-- å±æ€§ -->
											<template v-if="currentTab==='blog'">
												<span
													class="inline-flex items-center px-2 py-0.5 rounded bg-slate-100 text-slate-800 font-medium">
													{{ getI18n(item.category, 'zh') || 'æœªåˆ†ç±»' }}
												</span>
												<span>{{ item.read_time }} min</span>
											</template>
											<template v-else>
												<span
													class="inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-700 font-medium">
													{{ getI18n(item.type, 'zh') || 'æœªçŸ¥ç±»å‹' }}
												</span>
											</template>

											<!-- æ—¥æœŸ -->
											<span class="ml-auto text-[11px] text-slate-400">{{ item.date }}</span>
										</div>

										<div class="mt-3 flex gap-2">
											<button @click="openEditModal(item)"
												class="flex-1 text-slate-600 font-semibold text-xs bg-slate-50 px-3 py-2 rounded-lg active:bg-slate-100">
												ç¼–è¾‘
											</button>
											<button @click="deleteItem(item.id)"
												class="flex-1 text-red-600 font-semibold text-xs bg-red-50 px-3 py-2 rounded-lg active:bg-red-100">
												åˆ é™¤
											</button>
										</div>
									</div>
								</div>
							</div>

							<div v-if="displayList.length === 0"
								class="px-6 py-16 text-center text-slate-400 flex flex-col items-center justify-center">
								<span class="text-4xl mb-4">ğŸ“­</span>
								<span class="text-sm">æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æ–°å¢</span>
							</div>
						</div>

						<!-- ===== Desktop Table (>= md) ===== -->
						<table class="hidden md:table w-full text-sm text-left">
							<thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase font-semibold">
								<tr>
									<th class="px-6 py-4 w-20 text-center">æ’åº</th>
									<th class="px-6 py-4 w-24">å°é¢</th>
									<th class="px-6 py-4 w-1/3">æ ‡é¢˜</th>
									<th class="px-6 py-4">å±æ€§</th>
									<th class="px-6 py-4">å‘å¸ƒæ—¶é—´</th>
									<th class="px-6 py-4 text-center">çŠ¶æ€</th>
									<th class="px-6 py-4 text-right">æ“ä½œ</th>
								</tr>
							</thead>

							<tbody class="divide-y divide-slate-100">
								<tr v-for="item in displayList" :key="item.id"
									class="hover:bg-slate-50/50 transition-colors group">
									<td class="px-6 py-4 text-center text-slate-400">{{ item.sort }}</td>

									<td class="px-6 py-4">
										<div
											class="w-16 h-10 bg-slate-100 rounded-md border border-slate-200 overflow-hidden relative">
											<img v-if="currentTab==='blog' ? item.cover : item.thumbnail"
												:src="currentTab==='blog' ? item.cover : item.thumbnail"
												class="w-full h-full object-cover">
											<div v-else
												class="w-full h-full flex items-center justify-center text-slate-300 text-xs">
												æ— å›¾</div>
										</div>
									</td>

									<td class="px-6 py-4">
										<div class="font-semibold text-slate-900 text-base mb-1 truncate">
											{{ getI18n(item.title, 'zh') || '(æœªå‘½å)' }}
										</div>
									</td>

									<td class="px-6 py-4 text-slate-500">
										<div v-if="currentTab==='blog'" class="flex flex-col gap-1">
											<span
												class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-800 w-fit">
												{{ getI18n(item.category, 'zh') || 'æœªåˆ†ç±»' }}
											</span>
											<span class="text-xs">{{ item.read_time }} min read</span>
										</div>
										<div v-else>
											<span
												class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-700">
												{{ getI18n(item.type, 'zh') || 'æœªçŸ¥ç±»å‹' }}
											</span>
										</div>
									</td>

									<td class="px-6 py-4 text-slate-500 text-xs">{{ item.date }}</td>

									<td class="px-6 py-4 text-center">
										<span
											:class="['px-2.5 py-1 rounded-full text-xs font-bold border',
											item.published ? 'bg-green-50 text-green-700 border-green-100' : 'bg-slate-100 text-slate-500 border-slate-200']">
											{{ item.published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿' }}
										</span>
									</td>

									<td class="px-6 py-4 text-right">
										<div
											class="opacity-0 group-hover:opacity-100 transition-opacity flex justify-end gap-3">
											<button @click="openEditModal(item)"
												class="text-slate-600 hover:text-slate-800 font-medium text-xs bg-slate-50 px-3 py-1.5 rounded-md hover:bg-slate-100 transition-colors">
												ç¼–è¾‘
											</button>
											<button @click="deleteItem(item.id)"
												class="text-red-500 hover:text-red-700 font-medium text-xs bg-red-50 px-3 py-1.5 rounded-md hover:bg-red-100 transition-colors">
												åˆ é™¤
											</button>
										</div>
									</td>
								</tr>

								<tr v-if="displayList.length === 0">
									<td colspan="7" class="px-6 py-20 text-center text-slate-400">
										<div class="flex flex-col items-center justify-center">
											<span class="text-4xl mb-4">ğŸ“­</span>
											<span>æš‚æ— æ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ–°å¢</span>
										</div>
									</td>
								</tr>
							</tbody>
						</table>

					</div>
				</div>

			</main>

			<!-- 4. ç¼–è¾‘å…¨å±å¼¹çª— (ç±»ä¼¼é£ä¹¦æ–‡æ¡£) -->
			<transition name="modal">
				<div v-if="showModal"
					class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
					<!-- ç§»é™¤ @click.selfï¼Œé˜²æ­¢è¯¯è§¦å…³é—­ -->
					<div
						class="bg-[#f5f6f7] w-full h-full md:w-[95vw] md:h-[95vh] md:rounded-xl shadow-2xl flex flex-col overflow-hidden relative">

						<!-- é¡¶éƒ¨æ“ä½œæ ï¼ˆç§»åŠ¨ç«¯æ›´ç´§å‡‘ + å®‰å…¨åŒºï¼‰ -->
						<div
							class="bg-white border-b border-slate-200 flex flex-col md:flex-row md:justify-between md:items-center px-4 md:px-6 py-3 md:py-0 md:h-16 shrink-0 z-20 shadow-sm pt-[calc(env(safe-area-inset-top)+0.75rem)] md:pt-0">
							<!-- å·¦ä¾§ï¼šå…³é—­ + æ ‡é¢˜ -->
							<div class="flex items-center gap-3 md:gap-4">
								<button @click="confirmClose"
									class="p-2 hover:bg-slate-100 rounded-lg text-slate-500 transition-colors"
									title="å…³é—­ (ä¸ä¿å­˜)">
									<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M6 18L18 6M6 6l12 12"></path>
									</svg>
								</button>
								<div class="flex flex-col leading-tight">
									<span
										class="font-bold text-slate-800 text-sm md:text-base">{{ editId ? 'ç¼–è¾‘å†…å®¹' : 'åˆ›å»ºæ–°å†…å®¹' }}</span>
									<span v-if="lastSavedTime" class="text-[11px] md:text-xs text-slate-400">ä¸Šæ¬¡ä¿å­˜:
										{{ lastSavedTime }}</span>
								</div>
							</div>

							<!-- å³ä¾§ï¼šå·¥å…·æŒ‰é’®ï¼ˆç§»åŠ¨ç«¯åˆ†ä¸¤è¡Œï¼‰ -->
							<div class="mt-3 md:mt-0 flex flex-col md:flex-row md:items-center gap-3 w-full md:w-auto">
								<div class="flex items-center gap-2 md:gap-3 w-auto max-sm:overflow-x-scroll md:w-auto">
									<!-- é¢„è§ˆåˆ‡æ¢ -->
									<div class="bg-slate-100 p-1 rounded-lg flex flex-1 md:flex-none">
										<button @click="isPreviewMode = false"
											:class="['flex-1 whitespace-nowrap md:flex-none px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium transition-all', !isPreviewMode ? 'bg-white text-slate-600 shadow-sm' : 'text-slate-500 hover:text-slate-700']">
											ç¼–è¾‘
										</button>
										<button @click="generatePreview"
											:class="['flex-1 whitespace-nowrap md:flex-none px-3 md:px-4 py-1.5 rounded-md text-xs md:text-sm font-medium transition-all', isPreviewMode ? 'bg-white text-slate-600 shadow-sm' : 'text-slate-500 hover:text-slate-700']">
											é¢„è§ˆ
										</button>
									</div>

									<!-- ç§»åŠ¨ç«¯ï¼šå±æ€§æŠ½å±‰æŒ‰é’® -->
									<button @click="showMobileMeta = true"
										class="md:hidden whitespace-nowrap px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 hover:bg-slate-50">
										å±æ€§
									</button>

									<button @click="copyCurrentLangPayload"
										class="px-3 h-10 rounded-xl bg-white border border-black/10 hover:bg-black/5 text-sm font-medium">
										<!-- å¤åˆ¶å½“å‰è¯­è¨€ --><i class="fa-regular fa-copy"></i>
									</button>

									<button @click="pasteToCurrentLangPayload"
										class="px-3 h-10 rounded-xl bg-white border border-black/10 hover:bg-black/5 text-sm font-medium">
										<!-- ä»å‰ªè´´æ¿ç²˜è´´ --><i class="fa-regular fa-paste"></i>
									</button>


									<!-- æŸ¥æ‰¾æ›¿æ¢ -->
									<button @click="openFindReplace()"
										class="px-3 py-2 whitespace-nowrap bg-white border border-slate-200 rounded-lg text-xs md:text-sm font-semibold text-slate-700 hover:bg-slate-50">
										æŸ¥æ‰¾æ›¿æ¢
									</button>

									<!-- è¯­è¨€åˆ‡æ¢ -->
									<select v-model="currentLang" @change="handleLangSwitch($event)"
										class="px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs md:text-sm font-medium outline-none focus:border-slate-500">
										<option v-for="lang in langs" :key="lang.code" :value="lang.code">
											{{ lang.label }}
										</option>
									</select>
								</div>

								<div class="flex items-center gap-2 md:gap-3 w-full md:w-auto">
									<div class="hidden md:block w-px h-6 bg-slate-300 mx-2"></div>

									<button @click="saveData" :disabled="saving"
										class="flex-1 md:flex-none justify-center px-5 md:px-6 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg font-medium shadow-md shadow-slate-200 transition-all flex items-center gap-2 text-sm">
										<span v-if="saving"
											class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
										{{ saving ? 'ä¿å­˜ä¸­...' : 'ä¿ å­˜' }}
									</button>
								</div>
							</div>
						</div>

						<!-- å†…å®¹ç¼–è¾‘åŒº (å·¦å³å¸ƒå±€ï¼šæ¡Œé¢å·¦å³ / æ‰‹æœºåªç•™ç¼–è¾‘åŒº) -->
						<div class="flex-1 overflow-hidden flex flex-col md:flex-row">

							<!-- ä¸»ç¼–è¾‘åŒº (Editor.js / é¢„è§ˆåŒº) -->
							<div class="flex-1 overflow-y-auto relative scroll-smooth bg-white" id="editor-container">

								<!-- A. é¢„è§ˆæ¨¡å¼æ˜¾ç¤º -->
								<div v-if="isPreviewMode"
									class="w-full h-full overflow-y-auto bg-white dark:bg-neutral-900">

									<!-- åšå®¢æ–‡ç« é¢„è§ˆç»“æ„ -->
									<template v-if="currentTab === 'blog'">
										<article class="py-16 md:py-24">
											<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
												<a href="#"
													class="inline-flex items-center gap-2 text-neutral-500 hover:text-neutral-700 mb-8 transition-colors cursor-not-allowed">
													<svg class="w-4 h-4" fill="none" stroke="currentColor"
														viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round"
															stroke-width="2" d="M15 19l-7-7 7-7"></path>
													</svg>
													è¿”å› (é¢„è§ˆ)
												</a>

												<div>
													<span
														class="text-sm font-medium text-primary-600 dark:text-primary-400 uppercase">
														{{ form.category[currentLang] || 'æœªåˆ†ç±»' }}
													</span>
													<h1
														class="text-3xl md:text-4xl font-bold mt-3 mb-6 text-neutral-900">
														{{ form.title[currentLang] || 'æ— æ ‡é¢˜' }}
													</h1>
													<div class="flex items-center gap-1 text-sm text-neutral-500 mb-8">
														<span>{{ form.date }}</span>
														<span>â€¢</span>
														<span>{{ form.read_time }} min read</span>
													</div>

													<div v-if="form.cover && form.showCover"
														class="aspect-video bg-neutral-100 rounded-2xl mb-10 overflow-hidden">
														<img :src="form.cover" class="w-full h-full object-cover">
													</div>

													<div
														class="prose prose-neutral max-w-none text-lg leading-relaxed text-neutral-600">
														<div v-html="renderArticleContent(form.content[currentLang])">
														</div>
													</div>
												</div>
											</div>
										</article>
									</template>

									<!-- åª’ä½“ä½œå“é¢„è§ˆç»“æ„ -->
									<template v-if="currentTab === 'media'">
										<section class="py-10 md:py-12 bg-white min-h-screen">
											<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
												<a href="#"
													class="inline-flex items-center gap-2 text-neutral-500 hover:text-black mb-10 transition-colors cursor-not-allowed">
													<svg class="w-4 h-4" fill="none" stroke="currentColor"
														viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round"
															stroke-width="2" d="M15 19l-7-7 7-7"></path>
													</svg>
													è¿”å› (é¢„è§ˆ)
												</a>

												<div>
													<div class="mb-8">
														<h1
															class="text-2xl md:text-4xl font-bold mb-4 text-neutral-900">
															{{ form.title[currentLang] || 'æ— æ ‡é¢˜' }}
														</h1>
														<div
															class="flex items-center gap-6 text-sm text-neutral-500 border-b border-neutral-100 pb-6">
															<span class="flex items-center gap-2">
																<svg class="w-4 h-4 opacity-70" fill="none"
																	stroke="currentColor" viewBox="0 0 24 24">
																	<path stroke-linecap="round" stroke-linejoin="round"
																		stroke-width="2"
																		d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
																	</path>
																</svg>
																{{ form.date }}
															</span>
															<span
																class="flex items-center gap-2 uppercase tracking-wide">
																<svg class="w-4 h-4 opacity-70" fill="none"
																	stroke="currentColor" viewBox="0 0 24 24">
																	<path stroke-linecap="round" stroke-linejoin="round"
																		stroke-width="2"
																		d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
																	</path>
																</svg>
																{{ form.type[currentLang] || 'Type' }}
															</span>
														</div>
													</div>

													<div class="prose prose-neutral max-w-none text-neutral-600">
														<div v-html="renderArticleContent(form.content[currentLang])">
														</div>
													</div>
												</div>
											</div>
										</section>
									</template>
								</div>

								<!-- B. ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º -->
								<div v-show="!isPreviewMode"
									class="editor-paper min-h-[800px] flex flex-col pt-8 md:pt-12 px-4">
									<input v-model="form.title[currentLang]" @input="isDirty=true" type="text"
										placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..."
										class="w-full leading-[1.2] md:leading-[1.3] text-3xl md:text-4xl font-bold text-slate-900 placeholder-slate-300 border-none outline-none bg-transparent py-1 px-1 mb-2 hover-bg-b5">

									<textarea v-model="form.excerpt[currentLang]" @input="isDirty=true"
										placeholder="è¾“å…¥ç®€çŸ­æ‘˜è¦/å‰¯æ ‡é¢˜..."
										class="w-full resize-y leading-[1.2] md:leading-[1.3] text-base md:text-lg text-slate-600 placeholder-slate-300 border-none outline-none bg-transparent resize-none py-1 px-1 hover-bg-b5"></textarea>

									<div id="editorjs" class="flex-1 pt-4"></div>
								</div>
							</div>

							<!-- å³ä¾§å±æ€§é…ç½®æ ï¼ˆæ¡Œé¢ç«¯ä¿æŒï¼‰ -->
							<div
								class="hidden md:block w-full md:w-80 bg-white border-l border-slate-200 overflow-y-auto p-5 space-y-6 shrink-0 shadow-[-4px_0_15px_rgba(0,0,0,0.02)]">
								<!-- ...å±æ€§æ å†…å®¹ä¿æŒä¹‹å‰ç‰ˆæœ¬... -->
								<h3 class="font-bold text-slate-800 text-sm uppercase tracking-wide">é¡µé¢å±æ€§</h3>

								<!-- å°é¢/ç¼©ç•¥å›¾ -->
								<div class="space-y-2">
									<label
										class="block text-xs font-bold text-slate-500 uppercase">{{ currentTab === 'blog' ? 'å°é¢å›¾ç‰‡' : 'ä½œå“ç¼©ç•¥å›¾' }}</label>

									<div
										class="relative group aspect-video bg-slate-100 rounded-lg border-2 border-dashed border-slate-200 hover:border-slate-400 overflow-hidden transition-all">
										<img v-if="form.cover" :src="form.cover"
											class="absolute inset-0 w-full h-full object-cover">
										<div
											class="absolute inset-0 flex flex-col items-center justify-center bg-black/0 group-hover:bg-black/40 transition-all">
											<button @click="$refs.fileInput.click()" @input="isDirty=true"
												class="px-3 py-1 bg-white/90 text-slate-700 text-xs font-bold rounded shadow-sm opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100">
												{{ uploadingCover ? 'ä¸Šä¼ ä¸­...' : 'ç‚¹å‡»ä¸Šä¼ ' }}
											</button>
										</div>
										<input type="file" ref="fileInput" @input="isDirty=true"
											@change="handleCoverUpload" accept="image/*" class="hidden">
									</div>

									<div class="flex gap-1">
										<input v-model="form.cover" type="text"
											class="flex-1 px-2 py-1.5 text-xs border rounded bg-slate-50 text-slate-600 focus:bg-white focus:ring-1 outline-none"
											placeholder="https://...">
										<a v-if="form.cover" :href="form.cover" target="_blank"
											class="px-2 py-1 bg-slate-100 border rounded hover:bg-slate-200 text-xs flex items-center justify-center">ğŸ”—</a>
									</div>
								</div>

								<!-- é¡µé¢å°é¢æ˜¾ç¤º -->
								<div v-if="currentTab === 'blog'" class="pt-4 border-t border-slate-200">
									<div class="flex items-center justify-between cursor-pointer"
										@click="form.showCover = !form.showCover; isDirty = true;">
										<span class="text-sm font-bold text-slate-700">é¡µé¢æ˜¾ç¤ºå°é¢</span>
										<div
											:class="['w-11 h-6 rounded-full transition-colors relative', form.showCover ? 'bg-green-500' : 'bg-slate-300']">
											<div
												:class="['absolute top-1 w-4 h-4 bg-white rounded-full transition-transform shadow-sm', form.showCover ? 'translate-x-6' : 'translate-x-1']">
											</div>
										</div>
									</div>
								</div>

								<!-- åˆ†ç±»/ç±»å‹ -->
								<div class="space-y-2">
									<label class="block text-xs font-bold text-slate-500 uppercase">
										{{ currentTab === 'blog' ? 'æ–‡ç« åˆ†ç±»' : 'ä½œå“ç±»å‹' }}
									</label>

									<select v-model="tempCategorySelection" @change="handleCategoryChange"
										class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-1 focus:ring-slate-500">
										<option value="" disabled>è¯·é€‰æ‹©...</option>
										<option v-for="opt in predefinedOptions" :key="opt.val" :value="opt.val">
											{{ opt.label[currentLang] }} ({{ opt.label['en'] }})
										</option>
									</select>

									<div v-if="tempCategorySelection === 'custom'" class="animate-fade-in-down mt-2">
										<input v-if="currentTab === 'blog'" v-model="form.category[currentLang]"
											@input="isDirty=true" type="text" placeholder="è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»"
											class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50/30 focus:ring-1 outline-none" />
										<input v-else v-model="form.type[currentLang]" @input="isDirty=true" type="text"
											placeholder="è¾“å…¥è‡ªå®šä¹‰ç±»å‹"
											class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50/30 focus:ring-1 outline-none" />
									</div>
								</div>

								<!-- åŸºç¡€ä¿¡æ¯ -->
								<div class="grid grid-cols-1 gap-4">
									<div>
										<label
											class="block text-xs font-bold text-slate-500 uppercase mb-1">å‘å¸ƒæ—¥æœŸ</label>
										<input v-model="form.date" :type="currentTab==='blog'?'date':'text'"
											class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-slate-500">
									</div>
									<div class="grid grid-cols-2 gap-3">
										<div>
											<label
												class="block text-xs font-bold text-slate-500 uppercase mb-1">æ’åºæƒé‡</label>
											<input v-model.number="form.sort" type="number"
												class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
										</div>
										<div v-if="currentTab === 'blog'">
											<label
												class="block text-xs font-bold text-slate-500 uppercase mb-1">é˜…è¯»æ—¶é•¿</label>
											<input v-model.number="form.read_time" type="number"
												class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
										</div>
									</div>
								</div>

								<!-- Slug -->
								<div v-if="currentTab === 'blog'">
									<label class="block text-xs font-bold text-slate-500 uppercase mb-1">Slug
										(URL)</label>
									<input v-model="form.slug" type="text"
										class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 outline-none">
								</div>

								<!-- å‘å¸ƒå¼€å…³ -->
								<div class="pt-4 border-t border-slate-200">
									<div class="flex items-center justify-between cursor-pointer"
										@click="form.published = !form.published">
										<span class="text-sm font-bold text-slate-700">å…¬å¼€çŠ¶æ€</span>
										<div
											:class="['w-11 h-6 rounded-full transition-colors relative', form.published ? 'bg-green-500' : 'bg-slate-300']">
											<div
												:class="['absolute top-1 w-4 h-4 bg-white rounded-full transition-transform shadow-sm', form.published ? 'translate-x-6' : 'translate-x-1']">
											</div>
										</div>
									</div>
									<p class="text-xs text-slate-400 mt-2">
										{{ form.published ? 'å½“å‰å†…å®¹å·²å¯¹å¤–å¯è§' : 'å½“å‰ä¸ºè‰ç¨¿æ¨¡å¼ï¼Œä»…åå°å¯è§' }}
									</p>
								</div>
							</div>
						</div>

						<!-- ===== Find / Replace Panel ===== -->
						<div v-if="fr.open" class="fixed inset-0 z-[100000] flex items-start justify-center p-4 md:p-8">
							<div class="absolute inset-0 bg-black/30" @click="fr.open=false"></div>

							<div
								class="relative w-full max-w-xl bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
								<div class="h-12 px-4 flex items-center justify-between border-b border-slate-200">
									<div class="font-bold text-slate-800 text-sm">æŸ¥æ‰¾ / æ›¿æ¢ï¼ˆå½“å‰è¯­è¨€ï¼š{{ currentLang }}ï¼‰</div>
									<button @click="fr.open=false"
										class="p-2 rounded-lg hover:bg-slate-100 text-slate-500">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
												d="M6 18L18 6M6 6l12 12"></path>
										</svg>
									</button>
								</div>

								<div class="p-4 space-y-3">
									<div class="grid grid-cols-1 gap-3">
										<div>
											<label
												class="block text-xs font-bold text-slate-500 uppercase mb-1">æŸ¥æ‰¾</label>
											<input v-model="fr.find"
												class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white outline-none focus:border-slate-500"
												placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„å†…å®¹">
										</div>

										<div>
											<label
												class="block text-xs font-bold text-slate-500 uppercase mb-1">æ›¿æ¢ä¸º</label>
											<input v-model="fr.replace"
												class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white outline-none focus:border-slate-500"
												placeholder="è¾“å…¥æ›¿æ¢å†…å®¹ï¼ˆå¯ä¸ºç©ºï¼‰">
										</div>
									</div>

									<div class="flex flex-wrap gap-2 pt-1">
										<label class="inline-flex items-center gap-2 text-sm text-slate-600">
											<input type="checkbox" v-model="fr.matchCase"
												class="rounded border-slate-300">
											åŒºåˆ†å¤§å°å†™
										</label>
										<label class="inline-flex items-center gap-2 text-sm text-slate-600">
											<input type="checkbox" v-model="fr.useRegex"
												class="rounded border-slate-300">
											æ­£åˆ™
										</label>
									</div>

									<div class="flex flex-wrap gap-2">
										<label class="inline-flex items-center gap-2 text-sm text-slate-600">
											<input type="checkbox" v-model="fr.scope.title"
												class="rounded border-slate-300">
											æ ‡é¢˜
										</label>
										<label class="inline-flex items-center gap-2 text-sm text-slate-600">
											<input type="checkbox" v-model="fr.scope.excerpt"
												class="rounded border-slate-300">
											æ‘˜è¦
										</label>
										<label class="inline-flex items-center gap-2 text-sm text-slate-600">
											<input type="checkbox" v-model="fr.scope.body"
												class="rounded border-slate-300">
											æ­£æ–‡
										</label>
									</div>

									<div class="flex items-center justify-between pt-2">
										<div class="text-xs text-slate-500">
											{{ fr.lastCount ? `å·²æ›¿æ¢ ${fr.lastCount} å¤„` : 'æç¤ºï¼šCtrl+F / Ctrl+H æ‰“å¼€' }}
										</div>

										<div class="flex items-center gap-2">
											<button @click="fr.open=false"
												class="px-3 py-2 rounded-lg border border-slate-200 text-slate-700 hover:bg-slate-50 text-sm">
												å–æ¶ˆ
											</button>
											<button @click="applyFindReplace()"
												class="px-4 py-2 rounded-lg bg-slate-600 text-white hover:bg-slate-700 text-sm font-semibold">
												å…¨éƒ¨æ›¿æ¢
											</button>
										</div>
									</div>

									<p v-if="fr.error" class="text-xs text-red-600">{{ fr.error }}</p>
								</div>
							</div>
						</div>

						<!-- ===== Mobile Bottom Sheet Meta (< md) ===== -->
						<div class="md:hidden fixed inset-0 z-[99999]" v-show="showMobileMeta"
							@click="showMobileMeta=false">

							<!-- mask -->
							<div class="absolute inset-0 bg-black/40"></div>

							<!-- sheet -->
							<div @click.stop class="absolute left-0 right-0 bottom-0 bg-white rounded-t-2xl shadow-2xl border-t border-slate-200 max-h-[82vh] overflow-hidden pb-[env(safe-area-inset-bottom)]
									   transform transition-transform duration-200 ease-out will-change-transform"
								:class="showMobileMeta ? 'translate-y-0' : 'translate-y-full'">

								<div class="h-12 px-4 flex items-center justify-between border-b border-slate-200">
									<div class="font-bold text-slate-800 text-sm">é¡µé¢å±æ€§</div>
									<button @click="showMobileMeta=false"
										class="p-2 rounded-lg hover:bg-slate-100 text-slate-500">
										<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
												d="M6 18L18 6M6 6l12 12"></path>
										</svg>
									</button>
								</div>

								<!-- å…³é”®ï¼šé‡å†…å®¹å»¶è¿ŸæŒ‚è½½ï¼Œç¬¬ä¸€æ¬¡æ‰“å¼€æ‰æ¸²æŸ“ -->
								<div v-if="mobileMetaMounted"
									class="p-4 overflow-y-auto max-h-[calc(82vh-3rem)] space-y-6">
									<!-- ä¸‹é¢è¿™æ®µï¼šè¿˜æ˜¯ä½ åŸæ¥çš„å±æ€§æ å†…å®¹ï¼ˆä¿æŒä¸å˜ï¼‰ -->

									<!-- å°é¢/ç¼©ç•¥å›¾ -->
									<div class="space-y-2">
										<label class="block text-xs font-bold text-slate-500 uppercase">
											{{ currentTab === 'blog' ? 'å°é¢å›¾ç‰‡' : 'ä½œå“ç¼©ç•¥å›¾' }}
										</label>

										<div
											class="relative group aspect-video bg-slate-100 rounded-lg border-2 border-dashed border-slate-200 hover:border-slate-400 overflow-hidden transition-all">
											<img v-if="form.cover" :src="form.cover"
												class="absolute inset-0 w-full h-full object-cover">
											<div
												class="absolute inset-0 flex flex-col items-center justify-center bg-black/0 group-hover:bg-black/40 transition-all">
												<button @click="$refs.fileInput.click()" @input="isDirty=true"
													class="px-3 py-1 bg-white/90 text-slate-700 text-xs font-bold rounded shadow-sm opacity-0 group-hover:opacity-100 transition-all transform scale-90 group-hover:scale-100">
													{{ uploadingCover ? 'ä¸Šä¼ ä¸­...' : 'ç‚¹å‡»ä¸Šä¼ ' }}
												</button>
											</div>
											<input type="file" ref="fileInput" @input="isDirty=true"
												@change="handleCoverUpload" accept="image/*" class="hidden">
										</div>

										<div class="flex gap-1">
											<input v-model="form.cover" type="text"
												class="flex-1 px-2 py-2 text-xs border rounded bg-slate-50 text-slate-600 focus:bg-white focus:ring-1 outline-none"
												placeholder="https://...">
											<a v-if="form.cover" :href="form.cover" target="_blank"
												class="px-2 py-1 bg-slate-100 border rounded hover:bg-slate-200 text-xs flex items-center justify-center">ğŸ”—</a>
										</div>
									</div>

									<!-- é¡µé¢å°é¢æ˜¾ç¤º -->
									<div v-if="currentTab === 'blog'" class="space-y-2">
										<label class="block text-xs font-bold text-slate-500 uppercase">é¡µé¢æ˜¾ç¤ºå°é¢</label>
										<button @click="form.showCover = form.showCover ? 0 : 1; isDirty = true"
											class="w-full flex items-center justify-between px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 hover:bg-white transition">
											<span class="text-slate-600">{{ form.showCover ? 'æ˜¾ç¤º' : 'éšè—' }}</span>
											<span
												:class="['w-11 h-6 rounded-full transition-colors relative', form.showCover ? 'bg-green-500' : 'bg-slate-300']">
												<span
													:class="['absolute top-1 w-4 h-4 bg-white rounded-full transition-transform shadow-sm', form.showCover ? 'translate-x-6' : 'translate-x-1']"></span>
											</span>
										</button>
									</div>

									<!-- åˆ†ç±»/ç±»å‹ -->
									<div class="space-y-2">
										<label class="block text-xs font-bold text-slate-500 uppercase">
											{{ currentTab === 'blog' ? 'æ–‡ç« åˆ†ç±»' : 'ä½œå“ç±»å‹' }}
										</label>

										<select v-model="tempCategorySelection" @change="handleCategoryChange"
											class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:ring-1 focus:ring-slate-500">
											<option value="" disabled>è¯·é€‰æ‹©...</option>
											<option v-for="opt in predefinedOptions" :key="opt.val" :value="opt.val">
												{{ opt.label[currentLang] }} ({{ opt.label['en'] }})
											</option>
										</select>

										<div v-if="tempCategorySelection === 'custom'"
											class="animate-fade-in-down mt-2">
											<input v-if="currentTab === 'blog'" v-model="form.category[currentLang]"
												@input="isDirty=true" type="text" placeholder="è¾“å…¥è‡ªå®šä¹‰åˆ†ç±»"
												class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50/30 focus:ring-1 outline-none" />
											<input v-else v-model="form.type[currentLang]" @input="isDirty=true"
												type="text" placeholder="è¾“å…¥è‡ªå®šä¹‰ç±»å‹"
												class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50/30 focus:ring-1 outline-none" />
										</div>
									</div>

									<!-- åŸºç¡€ä¿¡æ¯ -->
									<div class="grid grid-cols-1 gap-4">
										<div>
											<label
												class="block text-xs font-bold text-slate-500 uppercase mb-1">å‘å¸ƒæ—¥æœŸ</label>
											<input v-model="form.date" :type="currentTab==='blog'?'date':'text'"
												class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none focus:border-slate-500">
										</div>

										<div class="grid grid-cols-2 gap-3">
											<div>
												<label
													class="block text-xs font-bold text-slate-500 uppercase mb-1">æ’åºæƒé‡</label>
												<input v-model.number="form.sort" type="number"
													class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
											</div>
											<div v-if="currentTab === 'blog'">
												<label
													class="block text-xs font-bold text-slate-500 uppercase mb-1">é˜…è¯»æ—¶é•¿</label>
												<input v-model.number="form.read_time" type="number"
													class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none">
											</div>
										</div>
									</div>

									<!-- Slug -->
									<div v-if="currentTab === 'blog'">
										<label class="block text-xs font-bold text-slate-500 uppercase mb-1">Slug
											(URL)</label>
										<input v-model="form.slug" type="text"
											class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-600 outline-none">
									</div>

									<!-- å‘å¸ƒå¼€å…³ -->
									<div class="pt-4 border-t border-slate-200">
										<div class="flex items-center justify-between cursor-pointer"
											@click="form.published = !form.published">
											<span class="text-sm font-bold text-slate-700">å…¬å¼€çŠ¶æ€</span>
											<div
												:class="['w-11 h-6 rounded-full transition-colors relative', form.published ? 'bg-green-500' : 'bg-slate-300']">
												<div
													:class="['absolute top-1 w-4 h-4 bg-white rounded-full transition-transform shadow-sm', form.published ? 'translate-x-6' : 'translate-x-1']">
												</div>
											</div>
										</div>
										<p class="text-xs text-slate-400 mt-2">
											{{ form.published ? 'å½“å‰å†…å®¹å·²å¯¹å¤–å¯è§' : 'å½“å‰ä¸ºè‰ç¨¿æ¨¡å¼ï¼Œä»…åå°å¯è§' }}
										</p>
									</div>

									<div class="h-2"></div>
								</div>

								<!-- æœªæŒ‚è½½å‰ï¼šç»™ä¸€ä¸ªè¶…è½»å ä½ï¼Œæ‰“å¼€â€œç§’å¼€â€ -->
								<div v-else class="p-6 text-center text-slate-400 text-sm">
									åŠ è½½å±æ€§é¢æ¿â€¦
								</div>

							</div>
						</div>

					</div>
				</div>
			</transition>

			<!-- ä¸Šä¼  Toastï¼ˆURL + è¿›åº¦æ¡ï¼šæ°¸è¿œåœ¨å³ä¸‹è§’æ˜¾ç¤ºï¼‰ -->
			<div v-if="showUploadToast"
				class="fixed bottom-6 right-6 z-[99999] w-[360px] max-w-[92vw] bg-white border border-slate-200 shadow-lg rounded-2xl px-4 py-3 space-y-2">

				<div class="flex items-center gap-2">
					<span class="text-xs text-slate-500 shrink-0">URLï¼š</span>
					<span class="text-xs flex-1 truncate text-slate-700">{{ lastUploadedUrl || 'ï¼ˆç­‰å¾…ä¸Šä¼ /å›å¡«ï¼‰' }}</span>

					<button v-if="lastUploadedUrl" @click="copyUrl(lastUploadedUrl)"
						class="px-2 py-1 text-xs rounded-lg bg-slate-100 hover:bg-slate-200 shrink-0">
						å¤åˆ¶
					</button>
					<button v-else
						class="px-2 py-1 text-xs rounded-lg bg-slate-100 text-slate-400 cursor-not-allowed shrink-0">
						å¤åˆ¶
					</button>
				</div>

				<div v-if="uploadState.active" class="space-y-1">
					<div class="flex items-center justify-between text-[11px] text-slate-500">
						<span>{{ uploadState.label || 'ä¸Šä¼ ä¸­...' }}</span>
						<span>{{ uploadState.percent }}%</span>
					</div>
					<div class="h-2 rounded-full bg-slate-200 overflow-hidden">
						<div class="h-full bg-slate-600 transition-all" :style="{ width: uploadState.percent + '%' }">
						</div>
					</div>
				</div>
			</div>


		</div>

		<script>
			const {
				createApp,
				ref,
				reactive,
				computed,
				watch,
				onMounted,
				onBeforeUnmount,
				nextTick
			} = Vue

			// ================= é…ç½®åŒºåŸŸ =================
			const SUPABASE_URL = "https://sbr.dorafx.top/https://madghoaphfwnrxgqyzse.supabase.co";
			const SUPABASE_ANON_KEY = "sb_publishable_F4mlp5yE_bMZca6xRS3eOQ_nsbynRm5";
			const R2_UPLOAD_ENDPOINT = "https://r2-uploader.sqxvafilm.workers.dev/upload"
			// ===========================================

			// é¢„è®¾é€‰é¡¹ (å››å›½è¯­è¨€)
			const BLOG_CATEGORIES = [{
					val: 'tech',
					label: {
						zh: 'æŠ€æœ¯ç ”ç©¶',
						en: 'Tech',
						ja: 'æŠ€è¡“',
						ko: 'ê¸°ìˆ '
					}
				},
				{
					val: 'industry',
					label: {
						zh: 'è¡Œä¸šè§‚å¯Ÿ',
						en: 'Industry',
						ja: 'æ¥­ç•Œã‚¦ã‚©ãƒƒãƒ',
						ko: 'ì—…ê³„ ë™í–¥'
					}
				},
				{
					val: 'essay',
					label: {
						zh: 'éšç¬”æ‚è°ˆ',
						en: 'Essay',
						ja: 'éšç­†',
						ko: 'ìˆ˜í•„'
					}
				},
				{
					val: 'reflection',
					label: {
						zh: 'æ€è€ƒæ€»ç»“',
						en: 'Reflection',
						ja: 'æŒ¯ã‚Šè¿”ã‚Š',
						ko: 'íšŒê³ '
					}
				},
				{
					val: 'life',
					label: {
						zh: 'æ—¥å¸¸ç”Ÿæ´»',
						en: 'Life',
						ja: 'æ—¥å¸¸',
						ko: 'ì¼ìƒ'
					}
				},
				{
					val: 'custom',
					label: {
						zh: 'å…¶ä»– (è‡ªå®šä¹‰)',
						en: 'Other',
						ja: 'ãã®ä»–',
						ko: 'ê¸°íƒ€'
					}
				},
			]

			const MEDIA_TYPES = [{
					val: 'image',
					label: {
						zh: 'å›¾ç‰‡',
						en: 'Image',
						ja: 'å†™çœŸ',
						ko: 'ì‚¬ì§„'
					}
				},
				{
					val: 'video',
					label: {
						zh: 'è§†é¢‘',
						en: 'Video',
						ja: 'å‹•ç”»',
						ko: 'ë™ì˜ìƒ'
					}
				},
				{
					val: 'design',
					label: {
						zh: 'è®¾è®¡ä½œå“',
						en: 'Design',
						ja: 'ãƒ‡ã‚¶ã‚¤ãƒ³',
						ko: 'ë””ìì¸'
					}
				},
				{
					val: 'custom',
					label: {
						zh: 'å…¶ä»– (è‡ªå®šä¹‰)',
						en: 'Other',
						ja: 'ãã®ä»–',
						ko: 'ê¸°íƒ€'
					}
				},
			]

			createApp({
				setup() {
					const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

					// ===== åŸºç¡€çŠ¶æ€ =====
					const session = ref(null)
					const email = ref('')
					const password = ref('')
					const msg = ref('')
					const loading = ref(false)

					const currentTab = ref('blog') // 'blog' | 'media'
					const listCache = reactive({
						blog: [],
						media: []
					})

					const showModal = ref(false)
					const saving = ref(false)
					const uploadingCover = ref(false)
					const editId = ref(null)
					const lastSavedTime = ref('')

					const isPreviewMode = ref(false)

					// ç§»åŠ¨ç«¯ meta é¢æ¿
					const showMobileMeta = ref(false)
					const mobileMetaMounted = ref(false)
					watch(showMobileMeta, (v) => {
						if (v) mobileMetaMounted.value = true
					})

					// ===== è¯­è¨€ =====
					const langs = [{
							code: 'zh',
							label: 'ä¸­æ–‡'
						},
						{
							code: 'en',
							label: 'English'
						},
						{
							code: 'ja',
							label: 'æ—¥æœ¬èª'
						},
						{
							code: 'ko',
							label: 'í•œêµ­ì–´'
						},
					]
					const currentLang = ref('zh')
					const prevLang = ref('zh')

					// ===== è¡¨å• =====
					const form = reactive({
						sort: 0,
						published: false,
						date: '',
						cover: '',
						showCover: 1,
						slug: '',
						read_time: 5,
						type: {
							zh: '',
							en: '',
							ja: '',
							ko: ''
						},
						category: {
							zh: '',
							en: '',
							ja: '',
							ko: ''
						},
						title: {
							zh: '',
							en: '',
							ja: '',
							ko: ''
						},
						excerpt: {
							zh: '',
							en: '',
							ja: '',
							ko: ''
						},
						content: {
							zh: {
								blocks: []
							},
							en: {
								blocks: []
							},
							ja: {
								blocks: []
							},
							ko: {
								blocks: []
							}
						},
					})

					// ===== æ¯è¯­è¨€è‰ç¨¿ç¼“å­˜ï¼ˆEditorJS dataï¼‰=====
					const drafts = reactive({
						zh: {
							blocks: []
						},
						en: {
							blocks: []
						},
						ja: {
							blocks: []
						},
						ko: {
							blocks: []
						},
					})

					// ===== è„å€¼æ£€æµ‹ =====
					const isDirty = ref(false)
					let lastSavedSnapshot = ''

					function deepClone(obj) {
						try {
							return structuredClone(obj)
						} catch (e) {
							return JSON.parse(JSON.stringify(obj || {}))
						}
					}

					function normalizeEditorData(d) {
						if (!d || typeof d !== 'object') return {
							blocks: []
						}
						if (!Array.isArray(d.blocks)) return {
							blocks: []
						}
						return d
					}

					function snapshot() {
						// å…³é”®ï¼šå¯¹ reactive åš deepCloneï¼Œå† stringify
						return JSON.stringify({
							tab: currentTab.value,
							editId: editId.value,
							form: deepClone(form),
							drafts: deepClone(drafts),
						})
					}

					function recomputeDirty() {
						isDirty.value = snapshot() !== lastSavedSnapshot
					}

					// ===== ä¸‹æ‹‰ï¼šåˆ†ç±»/ç±»å‹ =====
					const tempCategorySelection = ref('')
					const displayList = computed(() => listCache[currentTab.value] || [])
					const predefinedOptions = computed(() => currentTab.value === 'blog' ? BLOG_CATEGORIES : MEDIA_TYPES)

					function syncCategorySelection() {
						const obj = currentTab.value === 'blog' ? form.category : form.type

						const candidate =
							(obj?.[currentLang.value] || '').trim() ||
							(obj?.['zh'] || '').trim() ||
							(langs.map(l => (obj?.[l.code] || '').trim()).find(v => v) || '')

						if (!candidate) {
							tempCategorySelection.value = '';
							return
						}

						const found = predefinedOptions.value.find(opt => {
							if (opt.val === candidate) return true
							return langs.some(l => (opt.label?.[l.code] || '') === candidate)
						})

						tempCategorySelection.value = found ? found.val : 'custom'
					}

					function handleCategoryChange() {
						const val = tempCategorySelection.value
						if (val === 'custom') return

						const opt = predefinedOptions.value.find(o => o.val === val)
						if (!opt) return

						const lang = currentLang.value
						const picked =
							(opt.label && (opt.label[lang] || opt.label.en || opt.label.zh)) || ''

						if (currentTab.value === 'blog') {
							form.category[lang] = picked
						} else {
							form.type[lang] = picked
						}

						recomputeDirty()
					}


					// ===== Supabase CRUD =====
					async function login() {
						loading.value = true
						msg.value = ''
						const {
							data,
							error
						} = await supabase.auth.signInWithPassword({
							email: email.value.trim(),
							password: password.value
						})
						loading.value = false
						if (error) msg.value = error.message
						else {
							session.value = data.session;
							fetchList(true)
						}
					}

					async function logout() {
						await supabase.auth.signOut()
						session.value = null
						listCache.blog = []
						listCache.media = []
					}

					async function fetchList(forceRefresh = false) {
						if (!forceRefresh && listCache[currentTab.value].length > 0) return

						const selectFields = currentTab.value === 'blog' ?
							'id, sort, published, date, cover, showCover, title, category, read_time, slug' :
							'id, sort, published, date, thumbnail, title, type'

						const {
							data,
							error
						} = await supabase
							.from(currentTab.value)
							.select(selectFields)
							.order('sort', {
								ascending: true
							})
							.order('date', {
								ascending: false
							})

						if (error) {
							alert('Error: ' + error.message);
							return
						}

						const formatted = (data || []).map(item => {
							if (currentTab.value === 'media') item.cover = item.thumbnail
							return item
						})
						listCache[currentTab.value] = formatted
					}

					function switchTab(tab) {
						currentTab.value = tab
						fetchList()
					}

					async function fetchDetail(id) {
						const {
							data,
							error
						} = await supabase.from(currentTab.value).select('*').eq('id', id).single()
						return {
							data,
							error
						}
					}

					async function deleteItem(id) {
						if (!confirm('ç¡®å®šåˆ é™¤?')) return
						const {
							error
						} = await supabase.from(currentTab.value).delete().eq('id', id)
						if (error) alert('åˆ é™¤å¤±è´¥ï¼š' + error.message)
						else fetchList(true)
					}


					// ===== ä¸Šä¼  Toastï¼ˆå¼ºåˆ¶ç¨³å®šæ˜¾ç¤ºè¿›åº¦æ¡ï¼‰=====
					const lastUploadedUrl = ref('')
					const showUploadToast = ref(false)

					const uploadState = reactive({
						active: false,
						percent: 0,
						label: ''
					})

					// å†…éƒ¨è®¡æ—¶å™¨ï¼šä¿è¯è¿›åº¦æ¡è‡³å°‘æ˜¾ç¤ºä¸€æ®µæ—¶é—´ï¼Œä¸ä¼šâ€œä¸€é—ªè€Œè¿‡â€
					let __toastHideTimer = null
					let __toastActiveOffTimer = null
					let __toastStartedAt = 0
					const __TOAST_MIN_ACTIVE_MS = 500 // è¿›åº¦æ¡æœ€çŸ­å±•ç¤ºæ—¶é—´
					const __TOAST_AUTO_HIDE_MS = 1800 // å®Œæˆåè‡ªåŠ¨éšè—

					function __clearToastTimers() {
						if (__toastHideTimer) clearTimeout(__toastHideTimer)
						if (__toastActiveOffTimer) clearTimeout(__toastActiveOffTimer)
						__toastHideTimer = null
						__toastActiveOffTimer = null
					}

					function showToast(url = '') {
						if (url) lastUploadedUrl.value = url
						showUploadToast.value = true
					}

					function hideToastLater(ms = __TOAST_AUTO_HIDE_MS) {
						__clearToastTimers()
						__toastHideTimer = setTimeout(() => {
							// åªæœ‰ä¸åœ¨ä¸Šä¼ ï¼ˆactive=falseï¼‰æ‰éšè—
							if (!uploadState.active) showUploadToast.value = false
						}, ms)
					}

					function setToastProgress(percent, label = 'ä¸Šä¼ ä¸­...') {
						// âœ… æ¯æ¬¡å¼€å§‹ä¸Šä¼ éƒ½é‡ç½®èµ·å§‹æ—¶é—´
						if (!uploadState.active) __toastStartedAt = Date.now()

						uploadState.active = true
						uploadState.percent = Math.max(0, Math.min(100, Number(percent) || 0))
						uploadState.label = label
						showUploadToast.value = true

						// âœ… ä¸Šä¼ ä¸­ä¸è¦è®©ä»»ä½•è‡ªåŠ¨éšè—å®šæ—¶å™¨å¹²æ‰°
						__clearToastTimers()
					}

					function finishToast(url = '') {
						// âœ… å®Œæˆä¹Ÿä¿æŒ active=true ä¸€å°æ®µæ—¶é—´ï¼Œè®© v-if ä¸€å®šèƒ½æ¸²æŸ“å‡ºæ¥
						const elapsed = Date.now() - (__toastStartedAt || Date.now())
						const wait = Math.max(0, __TOAST_MIN_ACTIVE_MS - elapsed)

						if (url) lastUploadedUrl.value = url
						showUploadToast.value = true

						uploadState.active = true
						uploadState.percent = 100
						uploadState.label = 'ä¸Šä¼ å®Œæˆ'

						__clearToastTimers()

						// å…ˆä¿è¯æœ€çŸ­å±•ç¤ºï¼Œå†å…³é—­ activeï¼Œå†è‡ªåŠ¨éšè—
						__toastActiveOffTimer = setTimeout(() => {
							uploadState.active = false
							// å…³é—­ active åå†éšè— toast
							hideToastLater(__TOAST_AUTO_HIDE_MS)
						}, wait)
					}

					// ï¼ˆå¯é€‰ï¼‰å¤±è´¥æ€ï¼šä¹Ÿæ˜¾ç¤ºè¿›åº¦æ¡ä¸€ä¼šå„¿ï¼Œä¸è¦â€œå•¥ä¹Ÿæ²¡çœ‹åˆ°â€
					function failToast(errMsg = 'ä¸Šä¼ å¤±è´¥') {
						const elapsed = Date.now() - (__toastStartedAt || Date.now())
						const wait = Math.max(0, __TOAST_MIN_ACTIVE_MS - elapsed)

						showUploadToast.value = true
						uploadState.active = true
						uploadState.label = errMsg
						// percent ä¸åŠ¨ä¹Ÿè¡Œï¼Œç»™ä¸ª 100 æ›´ç›´è§‚
						uploadState.percent = Math.max(uploadState.percent || 0, 100)

						__clearToastTimers()
						__toastActiveOffTimer = setTimeout(() => {
							uploadState.active = false
							hideToastLater(2200)
						}, wait)
					}

					// ===== ç»™ Editor.js çš„ uploaderï¼šä¸è¦å† setTimeout ä¹±å…³ Toast =====
					function uploadForEditor(file) {
						const bucket = currentTab.value === "blog" ? "blog" : "media"
						const isImage = file?.type?.startsWith("image/")

						// å…ˆäº®èµ·æ¥
						setToastProgress(1, isImage ? "å‡†å¤‡å›¾ç‰‡..." : "å‡†å¤‡ä¸Šä¼ ...")

						const task = (async () => {
							let upFile = file

							// å›¾ç‰‡å…ˆå‹ç¼©
							if (isImage) {
								setToastProgress(5, "å‹ç¼©å›¾ç‰‡...")
								upFile = await compressImageToLimit(file, {
									maxSizeKB: 150
								})
							}

							// å…³é”®ï¼šç”¨ XHR ç‰ˆæœ¬æ‹¿è¿›åº¦
							const url = await uploadFileToR2WithProgress(upFile, bucket, ({
								percent
							}) => {
								setToastProgress(percent, isImage ? "ä¸Šä¼ å›¾ç‰‡ä¸­..." : "ä¸Šä¼ ä¸­...")
							})

							finishToast(url)

							return {
								success: 1,
								file: {
									url
								}
							}
						})()

						return task.catch((e) => {
							failToast("ä¸Šä¼ å¤±è´¥")
							throw e
						})
					}





					async function copyUrl(url) {
						try {
							await navigator.clipboard.writeText(url)
						} catch (e) {}
					}

					function loadImage(file) {
						return new Promise((resolve, reject) => {
							const img = new Image()
							img.onload = () => resolve(img)
							img.onerror = reject
							img.src = URL.createObjectURL(file)
						})
					}

					function canvasToBlob(canvas, type, quality) {
						return new Promise((resolve) => canvas.toBlob(resolve, type, quality))
					}

					async function compressImageToLimit(file, {
						maxWidth = 1280,
						maxSizeKB = 150,
						initialQuality = 0.85,
						minQuality = 0.4,
						step = 0.08
					} = {}) {
						if (!file?.type?.startsWith("image/")) return file;

						// --- helpers (å†…éƒ¨åŠ ï¼Œä¸æ”¹å¤–éƒ¨è°ƒç”¨) ---
						const supportsType = (type) => {
							const c = document.createElement("canvas");
							return c.toDataURL(type).startsWith(`data:${type}`);
						};

						const targetBytes = Math.max(1, maxSizeKB * 1024);

						// é€‰æ‹©è¾“å‡ºæ ¼å¼ï¼šä¼˜å…ˆ webpï¼Œå† jpegï¼ˆpng ä¸æ”¯æŒ qualityï¼Œä¸é€‚åˆä½“ç§¯é™åˆ¶ï¼‰
						const canWebp = supportsType("image/webp");
						const outType = canWebp ? "image/webp" : "image/jpeg";
						const outExt = canWebp ? ".webp" : ".jpg";

						// --- 1) load & resize ---
						const img = await loadImage(file);
						let width = img.naturalWidth || img.width;
						let height = img.naturalHeight || img.height;

						if (width > maxWidth) {
							const r = maxWidth / width;
							width = maxWidth;
							height = Math.round(height * r);
						}

						const canvas = document.createElement("canvas");
						canvas.width = width;
						canvas.height = height;

						const ctx = canvas.getContext("2d", {
							alpha: true
						});
						ctx.imageSmoothingEnabled = true;
						ctx.imageSmoothingQuality = "high"; // âœ… ç”»è´¨å…³é”®
						ctx.clearRect(0, 0, width, height);
						ctx.drawImage(img, 0, 0, width, height);

						// --- 2) find BEST quality under size (binary search) ---
						// åœ¨ [minQuality, initialQuality] é‡Œæ‰¾â€œæ»¡è¶³ä½“ç§¯çš„æœ€é«˜è´¨é‡â€
						const findBestBlob = async () => {
							// å…ˆè¯• initialQualityï¼Œä¸€æ¬¡å‘½ä¸­ç›´æ¥è¿”å›ï¼ˆæœ€å¿«ï¼‰
							let tryBlob = await canvasToBlob(canvas, outType, initialQuality);
							if (tryBlob && tryBlob.size <= targetBytes) {
								return {
									blob: tryBlob,
									quality: initialQuality
								};
							}

							let lo = minQuality;
							let hi = initialQuality;
							let best = null;
							let bestQ = minQuality;

							// è¿­ä»£æ¬¡æ•°ï¼šç”¨ step ç²—ç•¥æ˜ å°„ä¸€ä¸‹ï¼Œä¸è®©å®ƒå¤ªæ…¢
							const iters = Math.max(6, Math.min(10, Math.ceil((hi - lo) / Math.max(0.02,
								step / 2))));

							for (let i = 0; i < iters; i++) {
								const mid = (lo + hi) / 2;
								const b = await canvasToBlob(canvas, outType, mid);
								if (!b) break;

								if (b.size <= targetBytes) {
									best = b;
									bestQ = mid;
									lo = mid; // âœ… å°è¯•æ›´é«˜ç”»è´¨
								} else {
									hi = mid; // âŒ å¤ªå¤§ï¼Œé™ä½ç”»è´¨
								}
							}

							// æœ€ç»ˆå¦‚æœ best ä»ç„¶æ²¡æœ‰ï¼Œè¯´æ˜ minQuality ä¹Ÿå‹ä¸è¿›
							return {
								blob: best,
								quality: bestQ
							};
						};

						let {
							blob,
							quality
						} = await findBestBlob();

						// --- 3) å¦‚æœ minQuality ä¹Ÿå‹ä¸è¿›ï¼šä¼˜å…ˆâ€œè½»å¾®é™åˆ†è¾¨ç‡â€ï¼Œæ¯”æŠŠè´¨é‡æ‹‰å¾—å¾ˆç³Šæ›´å¥½çœ‹ ---
						// é™åˆ†è¾¨ç‡æœ€å¤š 3 æ¬¡ï¼Œæ¯æ¬¡ç¼©å°åˆ° 0.9 å€ï¼ˆå¾ˆå…‹åˆ¶ï¼‰
						let downscaleTries = 0;
						while ((!blob || blob.size > targetBytes) && downscaleTries < 3) {
							downscaleTries++;

							const newW = Math.max(1, Math.round(canvas.width * 0.9));
							const newH = Math.max(1, Math.round(canvas.height * 0.9));

							const tmp = document.createElement("canvas");
							tmp.width = newW;
							tmp.height = newH;

							const tctx = tmp.getContext("2d", {
								alpha: true
							});
							tctx.imageSmoothingEnabled = true;
							tctx.imageSmoothingQuality = "high";
							tctx.clearRect(0, 0, newW, newH);
							tctx.drawImage(canvas, 0, 0, newW, newH);

							canvas.width = newW;
							canvas.height = newH;
							ctx.clearRect(0, 0, newW, newH);
							ctx.drawImage(tmp, 0, 0, newW, newH);

							// é‡æ–°æ‰¾ä¸€æ¬¡æœ€ä½³è´¨é‡ï¼ˆä¸Šé™è¿˜æ˜¯ initialQualityï¼‰
							({
								blob,
								quality
							} = await findBestBlob());
						}

						// --- 4) å…œåº•ï¼šå¦‚æœä»ç„¶æ²¡æœ‰ blobï¼Œè¿”å›åŸæ–‡ä»¶ ---
						if (!blob) return file;

						// --- 5) è¾“å‡ºæ–‡ä»¶åå¤„ç† ---
						const newName = file.name.replace(/\.(png|webp|jpe?g)$/i, outExt);

						return new File([blob], newName, {
							type: outType
						});
					}


					async function uploadFileToSupabase(file, bucketName = 'blog') {
						const compressed = await compressImageToLimit(file, {
							maxSizeKB: 150
						})
						const fileExt = (compressed.name.split('.').pop() || 'jpg').toLowerCase()
						const fileName = `${Date.now()}_${Math.random().toString(36).slice(2, 10)}.${fileExt}`

						const {
							error
						} = await supabase.storage.from(bucketName).upload(fileName, compressed)
						if (error) throw error

						const {
							data
						} = supabase.storage.from(bucketName).getPublicUrl(fileName)
						return data.publicUrl
					}

					async function uploadFileToR2(file, bucketName = "blog") {
						const fd = new FormData();
						fd.append("file", file);

						const res = await fetch(`${R2_UPLOAD_ENDPOINT}?bucket=${encodeURIComponent(bucketName)}`, {
							method: "POST",
							body: fd,
							// ï¼ˆå¯é€‰ï¼‰é‰´æƒï¼šæŠŠ supabase token å¸¦ç»™ worker
							// headers: { Authorization: `Bearer ${(await supabase.auth.getSession()).data.session.access_token}` }
						});

						const json = await res.json().catch(() => ({}));
						if (!res.ok || !json?.success || !json?.url) {
							throw new Error(json?.error || "R2 upload failed");
						}
						return json.url;
					}

					function uploadFileToR2WithProgress(file, bucketName = "blog", onProgress) {
						return new Promise((resolve, reject) => {
							const xhr = new XMLHttpRequest();

							const endpoint = new URL(R2_UPLOAD_ENDPOINT); // å¿…é¡»æ˜¯ .../upload
							endpoint.searchParams.set("bucket", bucketName);

							const fd = new FormData();
							fd.append("file", file);

							xhr.open("POST", endpoint.toString(), true);
							xhr.responseType = "text";
							xhr.timeout = 1000 * 60 * 10;

							// âœ… çœŸå®ä¸Šä¼ è¿›åº¦ï¼ˆFormData ä¹Ÿæœ‰ï¼‰
							xhr.upload.onprogress = (e) => {
								if (e.lengthComputable && e.total) {
									const pct = Math.max(1, Math.min(99, Math.round((e.loaded / e.total) *
										100)));
									onProgress?.({
										loaded: e.loaded,
										total: e.total,
										percent: pct
									});
								} else {
									// æ‹¿ä¸åˆ° totalï¼šæ…¢æ…¢å‡è¿›åº¦åˆ° 90
									const prev = xhr.__fakePct || 1;
									const next = Math.min(90, prev + Math.max(1, Math.round((90 - prev) *
										0.06)));
									xhr.__fakePct = next;
									onProgress?.({
										loaded: 0,
										total: 0,
										percent: next
									});
								}
							};

							xhr.onload = () => {
								try {
									const json = JSON.parse(xhr.responseText || "{}");
									if (xhr.status >= 200 && xhr.status < 300 && json?.success && json
										?.url) {
										onProgress?.({
											loaded: 1,
											total: 1,
											percent: 100
										});
										resolve(json.url);
									} else {
										reject(new Error(json?.error || `R2 upload failed (${xhr.status})`));
									}
								} catch (e) {
									reject(new Error("R2 upload parse failed"));
								}
							};

							xhr.onerror = () => reject(new Error("R2 upload network error"));
							xhr.ontimeout = () => reject(new Error("R2 upload timeout"));

							xhr.send(fd);
						});
					}





					function ensureVideoProgressBar(videoRootEl) {
						if (!videoRootEl) return null;
						let bar = videoRootEl.querySelector(':scope .video-progress');
						if (bar) return bar;

						bar = document.createElement('div');
						bar.className = 'video-progress';
						bar.innerHTML = `
					    <div class="video-progress__bar"><div class="video-progress__fill"></div></div>
					    <div class="video-progress__pct">0%</div>
					  `;
						videoRootEl.appendChild(bar);
						return bar;
					}

					function setVideoProgress(ctrlEl, percent, show = true) {
						if (!ctrlEl) return
						const bar = ctrlEl.querySelector('.video-progress')
						if (!bar) return

						const fill = bar.querySelector('.video-progress__fill')
						const pct = bar.querySelector('.video-progress__pct')

						const p = Math.max(0, Math.min(100, Number(percent) || 0))
						bar.style.display = show ? 'flex' : 'none'
						if (fill) fill.style.width = p + '%'
						if (pct) pct.textContent = p + '%'
					}




					async function handleCoverUpload(event) {
						const file = event.target.files?.[0];
						if (!file) return;

						uploadingCover.value = true;
						try {
							const bucket = currentTab.value === "blog" ? "blog" : "media";
							const isImage = file?.type?.startsWith("image/");
							const upFile = isImage ? await compressImageToLimit(file, {
								maxSizeKB: 150
							}) : file;

							const url = await uploadFileToR2(upFile, bucket);
							form.cover = url;
							recomputeDirty();
						} catch (e) {
							alert("ä¸Šä¼ å¤±è´¥: " + (e?.message || e));
						} finally {
							uploadingCover.value = false;
							event.target.value = "";
						}
					}




















					// ===== Media Controls (Image/Video) æ³¨å…¥å™¨ =====
					let __mediaObs = null

					function getDraftBlockById(lang, id) {
						const d = drafts?.[lang]
						if (!d?.blocks?.length) return null
						return d.blocks.find(b => b && (b.id === id)) || null
					}

					function getUrlFromBlock(block) {
						if (!block?.data) return ""
						const d = block.data
						return String(
							d.file?.url ||
							d.url ||
							d.source ||
							d.src ||
							""
						).trim()
					}


					async function updateBlockUrlInEditor({
						blockId,
						url,
						kind,
						noRender = false
					}) {
						const lang = currentLang.value;
						const nextUrl = String(url || "").trim();
						if (!blockId || !nextUrl) return false;

						// 1) å…ˆæ‹¿â€œå½“å‰ drafts é‡Œçš„ blockâ€ï¼ˆå¯èƒ½æ²¡æœ‰ï¼‰
						let draftBlock = getDraftBlockById(lang, blockId);

						// 2) ç”Ÿæˆè¦å†™å…¥çš„ dataï¼šå¦‚æœ drafts é‡Œæ²¡æœ‰ï¼Œå°±ä»ä¸€ä¸ªç©ºå¯¹è±¡å¼€å§‹
						const next = deepClone((draftBlock && draftBlock.data) ? draftBlock.data : {});

						// === å…¼å®¹ ImageTool / weekwood VideoTool ===
						next.file = {
							...(next.file || {}),
							url: nextUrl
						};
						next.url = nextUrl;
						next.source = nextUrl;
						next.src = nextUrl;

						if (kind === "image") {
							if (next.caption == null) next.caption = "";
							if (next.stretched == null) next.stretched = false;
							if (next.withBorder == null) next.withBorder = false;
							if (next.withBackground == null) next.withBackground = false;
						}
						if (kind === "video") {
							if (next.caption == null) next.caption = "";
							if (!next.meta) next.meta = {};
						}

						// 3) âœ… å…³é”®ï¼šä¸è¦æ±‚ drafts é‡Œå¿…é¡»å…ˆæœ‰ blockï¼Œå…ˆç›´æ¥ update editorï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
						let updated = false;
						try {
							await editor?.blocks?.update(blockId, next);
							updated = true;
						} catch (e) {
							updated = false;
							console.warn("[updateBlockUrlInEditor] blocks.update failed:", e);
						}

						// 4) update æˆåŠŸåï¼šç«‹åˆ» save å› draftsï¼Œä¿è¯ drafts æˆä¸ºçœŸæº
						if (updated) {
							try {
								const saved = await editor.save();
								drafts[lang] = normalizeEditorData(saved);
								loadDraftToForm(lang);
								recomputeDirty();
								requestAnimationFrame(() => scanAndInjectAllMediaCtrls());
								return true;
							} catch (e) {
								console.warn("[updateBlockUrlInEditor] save after update failed:", e);
								// ä¸ä¸­æ–­ï¼šç»§ç»­èµ° render å…œåº•
							}
						}

						// 5) update ä¸æˆåŠŸï¼šæ‰åš render / rebuild å…œåº•ï¼ˆæ›´é‡ï¼‰
						if (!noRender) {
							try {
								// ç”¨â€œå½“å‰ editor.save()â€æœ€ç¨³ï¼Œä¸ä¾èµ– drafts
								const saved = await editor.save();
								drafts[lang] = normalizeEditorData(saved);
								// æŠŠ nextUrl å¼ºè¡Œå†™è¿› drafts å¯¹åº” blockï¼ˆå³ä½¿ save å‡ºæ¥è¿˜æ²¡å¸¦ä¸Šï¼‰
								const idx = drafts[lang].blocks.findIndex(b => b?.id === blockId);
								if (idx >= 0) {
									drafts[lang].blocks[idx] = {
										...drafts[lang].blocks[idx],
										data: next
									};
								}
								loadDraftToForm(lang);

								await editor.render(deepClone(drafts[lang]));
								installMediaObserver(); // render ä¼šé‡å»º DOMï¼Œé‡æ–°è£…ä¸€ä¸‹
								recomputeDirty();
								requestAnimationFrame(() => scanAndInjectAllMediaCtrls());
								return true;
							} catch (e) {
								console.warn("[updateBlockUrlInEditor] render fallback failed:", e);
								try {
									await destroyEditor();
								} catch (_) {}
								await nextTick();
								initEditor();
								recomputeDirty();
								requestAnimationFrame(() => scanAndInjectAllMediaCtrls());
								return true;
							}
						}

						// noRender=true ä¸” update å¤±è´¥ï¼šè‡³å°‘æŠŠ drafts å†™ä¸Šï¼ˆé˜²æ­¢ä¸¢ï¼‰
						try {
							const saved = await editor.save();
							drafts[lang] = normalizeEditorData(saved);
							const idx = drafts[lang].blocks.findIndex(b => b?.id === blockId);
							if (idx >= 0) {
								drafts[lang].blocks[idx] = {
									...drafts[lang].blocks[idx],
									data: next
								};
							}
							loadDraftToForm(lang);
							recomputeDirty();
						} catch (e) {}

						requestAnimationFrame(() => scanAndInjectAllMediaCtrls());
						return false;
					}



					function createMediaCtrlEl({
						kind,
						url
					}) {
						const wrap = document.createElement('div')
						wrap.className = 'media-ctrl'
						wrap.innerHTML = `
					    <input class="media-ctrl__input" type="url" placeholder="ç²˜è´´ URLâ€¦"
					      value="${(url || '').replace(/"/g, '&quot;')}" />
					
					    <button class="media-ctrl__btn media-ctrl__apply" type="button">åº”ç”¨ URL</button>
					    <button class="media-ctrl__btn media-ctrl__upload" type="button">${kind === 'video' ? 'ä¸Šä¼ è§†é¢‘' : 'é‡æ–°ä¸Šä¼ '}</button>
					
					    <span class="media-ctrl__hint">
					      ${kind === 'video' ? 'ä¸Šä¼ å URL ä¼šè‡ªåŠ¨å›å¡«åˆ°è¾“å…¥æ¡†' : 'å›è½¦/åº”ç”¨å†™å…¥'}
					    </span>
					
					    <input class="media-ctrl__file" type="file" style="display:none" accept="${kind === 'image' ? 'image/*' : 'video/*'}" />
					  `
						return wrap
					}



					function findMediaRootInBlock(blockEl) {
						// ä½ ç°åœ¨ç”¨çš„å·¥å…· DOMï¼š
						// ImageTool: .image-tool
						// VideoTool: .video-tool
						const img = blockEl.querySelector('.image-tool')
						if (img) return {
							kind: 'image',
							root: img
						}

						const vid = blockEl.querySelector('.video-tool')
						if (vid) return {
							kind: 'video',
							root: vid
						}

						return null
					}

					function injectMediaCtrlIntoBlock(blockEl) {
						if (!blockEl) return

						const info = findMediaRootInBlock(blockEl)
						if (!info) return

						const blockId = blockEl.getAttribute('data-id')
						if (!blockId) return

						const lang = currentLang.value

						function getUrlFromDom(blockEl, kind) {
							if (kind === 'image') {
								const img = blockEl.querySelector(
									'.image-tool img, .image-tool__image-picture img, img.image-tool__image-picture')
								return (img?.getAttribute('src') || '').trim()
							}

							if (kind === 'video') {
								// weekwood è‡ªå¸¦è¾“å…¥æ¡†æˆ‘ä»¬ä¼šç”¨ CSS éšè—ï¼Œä½† DOM é‡Œä»å¯èƒ½å­˜åœ¨
								const input =
									blockEl.querySelector('.video-tool input[type="url"]') ||
									blockEl.querySelector('.video-tool input.cdx-input') ||
									blockEl.querySelector('.video-tool input[type="text"]')
								const v0 = (input?.value || '').trim()
								if (v0) return v0

								const source = blockEl.querySelector('.video-tool video source')
								const v1 = (source?.getAttribute('src') || '').trim()
								if (v1) return v1

								const video = blockEl.querySelector('.video-tool video')
								const v2 = (video?.getAttribute('src') || '').trim()
								if (v2) return v2

								return ''
							}

							return ''
						}

						// å·²ç»æœ‰ ctrl å°±åªåšâ€œå€¼åŒæ­¥â€ï¼Œä¸é‡å¤æ³¨å…¥
						const existed = blockEl.querySelector(':scope .media-ctrl')
						if (existed) {
							const inputEl = existed.querySelector('.media-ctrl__input')
							const kind = existed.dataset.kind

							const draftBlock = getDraftBlockById(lang, blockId)
							let latest = getUrlFromBlock(draftBlock)
							if (!latest) latest = getUrlFromDom(blockEl, kind)

							if (inputEl && latest && inputEl.value !== latest) inputEl.value = latest
							blockEl.dataset.mediaCtrlMounted = '1'
							return
						}

						// å–åˆå§‹ URLï¼ˆdraft ä¼˜å…ˆï¼Œdom å…œåº•ï¼‰
						const draftBlock = getDraftBlockById(lang, blockId)
						let url = getUrlFromBlock(draftBlock)
						if (!url) url = getUrlFromDom(blockEl, info.kind)

						// åˆ›å»ºæ§ä»¶
						const ctrl = createMediaCtrlEl({
							kind: info.kind,
							url
						})
						ctrl.dataset.blockId = blockId
						ctrl.dataset.kind = info.kind

						// æ’å…¥åˆ°åª’ä½“æ ¹é‡Œï¼ˆä¿è¯â€œå—å†…â€ï¼Œä¸ç”Ÿæˆé¢å¤– blockï¼‰
						try {
							info.root.appendChild(ctrl)
						} catch (e) {
							const contentEl =
								blockEl.querySelector('.ce-block__content') ||
								blockEl.querySelector('.ce-block__content > div') ||
								blockEl
							contentEl.appendChild(ctrl)
						}

						// ç»‘å®šäº‹ä»¶
						const input = ctrl.querySelector('.media-ctrl__input')
						const btnApply = ctrl.querySelector('.media-ctrl__apply')
						const btnUpload = ctrl.querySelector('.media-ctrl__upload')
						const file = ctrl.querySelector('.media-ctrl__file')

						const doApply = async () => {
							const nextUrl = (input.value || '').trim()
							if (!nextUrl) return
							await updateBlockUrlInEditor({
								blockId,
								url: nextUrl,
								kind: info.kind,
								noRender: false
							})
						}

						btnApply.addEventListener('click', doApply)
						input.addEventListener('keydown', (ev) => {
							if (ev.key === 'Enter') {
								ev.preventDefault()
								doApply()
							}
						})

						btnUpload.addEventListener('click', () => file.click())

						file.addEventListener('change', async () => {
							const f = file.files?.[0]
							if (!f) return

							const MAX_VIDEO = 20 * 1024 * 1024
							if (info.kind === 'video' && f.size > MAX_VIDEO) {
								alert('è§†é¢‘è¶…è¿‡ 20MBï¼Œæ— æ³•ä¸Šä¼ ã€‚è¯·å‹ç¼©åå†ä¼ ï¼ˆå»ºè®® H.264 + CRF 22~28ï¼‰ã€‚')
								file.value = ''
								return
							}

							try {
								btnUpload.disabled = true
								btnUpload.textContent = 'ä¸Šä¼ ä¸­...'

								// âœ… 1) ç«‹åˆ»æŠŠ Toast æ‰“å¼€ + è¿›åº¦æ¡æ¿€æ´»ï¼ˆä¸è¦ç­‰ awaitï¼‰
								setToastProgress(1, info.kind === 'video' ? 'ä¸Šä¼ è§†é¢‘ä¸­...' : 'ä¸Šä¼ å›¾ç‰‡ä¸­...')

								// âœ… 2) å¼ºåˆ¶è®©æµè§ˆå™¨å…ˆæ¸²æŸ“ä¸€å¸§ï¼ˆå¦åˆ™ä½ ä¼šâ€œæ²¡çœ‹åˆ°â€ï¼‰
								await nextTick()
								await new Promise(r => requestAnimationFrame(r))

								const bucket = currentTab.value === "blog" ? "blog" : "media"
								let upUrl = ''

								if (info.kind === 'image') {
									// å›¾ç‰‡ï¼šä½  fetch æ²¡æ³•æ‹¿çœŸå®è¿›åº¦ï¼Œè¿™é‡Œç»™ç”¨æˆ·ä¸€ä¸ªç¨³å®šçš„å‡è¿›åº¦
									setToastProgress(15, 'ä¸Šä¼ å›¾ç‰‡ä¸­...')
									const res = await uploadForEditor(f) // ä½ åŸæ¥çš„é€»è¾‘
									upUrl = res?.file?.url || ''
									setToastProgress(90, 'å¤„ç†å›¾ç‰‡ä¸­...')
								} else {
									// è§†é¢‘ï¼šXHR çœŸè¿›åº¦ï¼ˆå¹¶ä¸” lengthComputable=false ä¹Ÿä¼šæœ‰å‡è¿›åº¦ï¼‰
									const bucket = currentTab.value === "blog" ? "blog" : "media"

									// âœ… æ³¨æ„ï¼šä¸è¦ constï¼Œæ–°å€¼è¦å†™å›å¤–å±‚ upUrl
									upUrl = await uploadFileToR2WithProgress(f, bucket, ({
										percent
									}) => {
										setToastProgress(percent, "ä¸Šä¼ è§†é¢‘ä¸­...")
									})

									// è¿™é‡Œ finish ä¸€æ¬¡å°±å¤Ÿ
									finishToast(upUrl)
								}

								if (upUrl) {
									// âœ… 3) URL å›å¡«åˆ°è¾“å…¥æ¡†
									input.value = upUrl

									// âœ… 4) æ›´æ–° draftsï¼ˆä¸ renderï¼Œé¿å…æ§ä»¶ä¸¢ï¼‰
									await updateBlockUrlInEditor({
										blockId,
										url: upUrl,
										kind: info.kind,
										noRender: true
									})

									// âœ… 5) Toast å®Œæˆæ€
									finishToast(upUrl)

									// âœ… 6) ä¸‹ä¸€å¸§å†æ‰«ä¸€éï¼Œä¿è¯æ§ä»¶ç¨³å®š
									requestAnimationFrame(() => scanAndInjectAllMediaCtrls())
								} else {
									uploadState.active = false
									alert('ä¸Šä¼ å¤±è´¥ï¼šæœªè·å¾— URL')
								}
							} catch (e) {
								uploadState.active = false
								alert('ä¸Šä¼ å¤±è´¥ï¼š' + (e?.message || e))
							} finally {
								btnUpload.disabled = false
								btnUpload.textContent = info.kind === 'video' ? 'ä¸Šä¼ è§†é¢‘' : 'é‡æ–°ä¸Šä¼ '
								file.value = ''
							}
						})

						blockEl.dataset.mediaCtrlMounted = '1'
					}

					function scanAndInjectAllMediaCtrls() {
						const holder = document.getElementById('editorjs')
						if (!holder) return
						const blocks = holder.querySelectorAll('.ce-block')
						blocks.forEach(injectMediaCtrlIntoBlock)
					}

					function installMediaObserver() {
						const holder = document.getElementById('editorjs')
						if (!holder) return

						// å…ˆæ‰«ä¸€æ¬¡
						scanAndInjectAllMediaCtrls()

						// ç›‘å¬æ–°å¢/å˜åŒ–ï¼ˆæ’å…¥æ–° blockã€renderã€ç²˜è´´ç­‰ï¼‰
						if (__mediaObs) {
							try {
								__mediaObs.disconnect()
							} catch (e) {}
							__mediaObs = null
						}

						__mediaObs = new MutationObserver(() => {
							// ç”¨ rAF åˆå¹¶å¤šæ¬¡å˜æ›´
							requestAnimationFrame(() => scanAndInjectAllMediaCtrls())
						})
						__mediaObs.observe(holder, {
							childList: true,
							subtree: true
						})
					}

					function installToolbarClampForMedia() {
						const root = document.querySelector('#editorjs');
						const container = document.querySelector('#editor-container'); // ä½ å¤–å±‚æ»šåŠ¨å®¹å™¨
						if (!root || !container) return;

						const getFocusedBlock = () => {
							return root.querySelector(
								'.ce-block.ce-block--focused, .ce-block.ce-block--selected, .ce-block.ce-block--focused .ce-block, .ce-block:hover'
							);
						};

						const isMediaBlock = (blockEl) => {
							if (!blockEl) return false;
							return !!blockEl.querySelector('.image-tool, .video-tool');
						};

						const placeToolbar = () => {
							const tb = document.querySelector('.ce-toolbar');
							if (!tb) return;

							const focused = getFocusedBlock();
							if (!focused || !isMediaBlock(focused)) return;

							// è®¡ç®—ï¼šè®© toolbar çš„ top å¯¹é½åˆ°å½“å‰ block çš„ä¸Šæ–¹é™„è¿‘ï¼ˆç›¸å¯¹ editor-container çš„æ»šåŠ¨ä½“ç³»ï¼‰
							const cRect = container.getBoundingClientRect();
							const bRect = focused.getBoundingClientRect();

							// toolbar ç›®æ ‡ä½ç½®ï¼šblock é¡¶éƒ¨ - ä¸€ç‚¹ç‚¹åç§»
							const offset = 10; // ä½ æƒ³è®© toolbar ç¦» block é¡¶éƒ¨çš„è·ç¦»
							let desiredTop = (bRect.top - cRect.top) + container.scrollTop - offset;

							// clampï¼šåªåšè¾¹ç•Œä¿æŠ¤ï¼Œä¸è¦â€œå¼ºè¡Œ 8pxâ€
							const tbH = tb.offsetHeight || 42;
							const minTop = 8;
							const maxTop = container.scrollHeight - tbH - 8;
							desiredTop = Math.max(minTop, Math.min(maxTop, desiredTop));

							// å†™å…¥ï¼ˆå¼ºåˆ¶ç”¨ pxï¼Œé¿å…è¢« Editor.js å†™æˆå¥‡æ€ªè´Ÿæ•°ï¼‰
							tb.style.top = `${Math.round(desiredTop)}px`;
						};

						// 1) ç›‘å¬ toolbar style è¢« editor æ”¹åŠ¨ï¼ˆæœ€å…³é”®ï¼‰
						const tb = document.querySelector('.ce-toolbar');
						if (tb) {
							const obs = new MutationObserver(() => requestAnimationFrame(placeToolbar));
							obs.observe(tb, {
								attributes: true,
								attributeFilter: ['style']
							});
						}

						// 2) æ»šåŠ¨/é¼ æ ‡ç§»åŠ¨æ—¶ä¹Ÿè·Ÿä¸€æ¬¡ï¼ˆé¿å…æŸäº›æƒ…å†µä¸‹ toolbar ä¸æ›´æ–°ï¼‰
						container.addEventListener('scroll', () => requestAnimationFrame(placeToolbar), {
							passive: true
						});
						root.addEventListener('mousemove', () => requestAnimationFrame(placeToolbar), {
							passive: true
						});
						root.addEventListener('click', () => requestAnimationFrame(placeToolbar), {
							passive: true
						});

						// 3) é¦–æ¬¡å¯¹é½
						requestAnimationFrame(placeToolbar);
					}



					function uninstallMediaObserver() {
						if (__mediaObs) {
							try {
								__mediaObs.disconnect()
							} catch (e) {}
							__mediaObs = null
						}
					}


					// ===== Editor.js ç®¡ç†ï¼ˆå¤šè¯­è¨€ drafts ä½œä¸ºå”¯ä¸€çœŸæºï¼‰=====
					let editor = null
					let __changeTimer = null

					async function saveEditorToDraft(lang) {
						if (!editor) return
						try {
							const saved = await editor.save()
							drafts[lang] = normalizeEditorData(saved)
						} catch (e) {
							console.warn('[saveEditorToDraft] failed', e)
						}
					}

					function loadDraftToForm(lang) {
						form.content[lang] = normalizeEditorData(deepClone(drafts[lang]))
					}

					async function destroyEditor() {

						uninstallMediaObserver()

						if (!editor) return
						try {
							await editor.destroy()
						} catch (e) {}
						editor = null
					}

					function initEditor() {
						const holder = document.getElementById('editorjs')
						if (!holder) return
						holder.innerHTML = ''

						const data = normalizeEditorData(deepClone(drafts[currentLang.value] || {
							blocks: []
						}))

						try {
							editor = new EditorJS({
								holder: 'editorjs',
								data,
								placeholder: 'è¾“å…¥ "/" å‘¼å‡ºèœå•...',
								tools: {
									header: {
										class: Header,
										config: {
											levels: [1, 2, 3],
											defaultLevel: 2
										}
									},
									list: {
										class: NestedList,
										inlineToolbar: true
									},
									quote: Quote,
									code: CodeTool,
									table: Table,
									checklist: Checklist,
									marker: Marker,
									underline: Underline,
									inlineCode: InlineCode,
									embed: {
										class: Embed,
										inlineToolbar: false,
										config: {
											services: {
												youtube: true,
												vimeo: true,
												bilibili: true,
											}
										}
									},
									image: {
										class: ImageTool,
										config: {
											uploader: {
												uploadByFile: uploadForEditor,
												uploadByUrl: async (url) => ({
													success: 1,
													file: {
														url
													}
												}),
											}
										}
									},
									video: {
										class: VideoTool,
										config: {
											uploader: {
												uploadByFile: uploadForEditor,
												uploadByUrl: async (url) => ({
													success: 1,
													file: {
														url
													}
												}),
											},
											player: {
												controls: true,
												autoplay: false
											}
										}
									}
								},

								onReady: () => {

									if (editor?.blocks?.getBlockByIndex) {
										editor.blocks.stretchBlock = (index, status = true) => {
											const block = editor.blocks.getBlockByIndex(index);
											if (block) block.stretched = !!status; // BlockAPI way
										};
									}

									const c = document.getElementById('editor-container')
									if (c) c.scrollTop = 0

									installMediaObserver()
									installToolbarClampForMedia()

								},

								onChange: () => {
									clearTimeout(__changeTimer)
									__changeTimer = setTimeout(async () => {
										// åŒæ­¥ï¼šeditor -> drafts -> form
										await saveEditorToDraft(currentLang.value)
										loadDraftToForm(currentLang.value)
										recomputeDirty()
									}, 220)
								},
							})
						} catch (e) {
							console.error('[Editor init failed]', e)
						}
					}

					async function handleLangSwitch(e) {
						const newLang = e?.target?.value || currentLang.value
						const oldLang = prevLang.value

						const container = document.getElementById('editor-container')
						const oldScrollTop = container ? container.scrollTop : 0

						// å…ˆè½ç›˜æ—§è¯­è¨€
						if (editor && !isPreviewMode.value) {
							await saveEditorToDraft(oldLang)
							loadDraftToForm(oldLang)
						}

						prevLang.value = newLang
						// æ³¨æ„ï¼šv-model å·²ç»æŠŠ currentLang æ”¹äº†ï¼›è¿™é‡Œä¸å¼ºè¡Œæ”¹ï¼Œé¿å…æŠ–
						// currentLang.value = newLang

						syncCategorySelection()
						recomputeDirty()

						if (isPreviewMode.value) return

						// ç¼–è¾‘æ¨¡å¼ï¼šåª render æ–°è¯­è¨€ dataï¼›å¤±è´¥å°±é‡å»º
						if (editor) {
							const nextData = normalizeEditorData(deepClone(drafts[newLang] || {
								blocks: []
							}))
							try {
								await editor.render(nextData)
								await editor.render(nextData)
								installMediaObserver()
							} catch (err) {
								console.warn('[handleLangSwitch] render failed, rebuild', err)
								await destroyEditor()
								await nextTick()
								initEditor()
							}
						}

						nextTick(() => {
							const c = document.getElementById('editor-container')
							if (c) c.scrollTop = oldScrollTop
						})
					}

					// ===== æ‰“å¼€ç¼–è¾‘å¼¹çª— =====
					function resetFormAndDrafts() {
						form.sort = 0
						form.published = false
						form.date = new Date().toISOString().split('T')[0]
						form.cover = ''
						form.showCover = 1
						form.slug = ''
						form.read_time = 5

						langs.forEach(l => {
							form.title[l.code] = ''
							form.excerpt[l.code] = ''
							form.category[l.code] = ''
							form.type[l.code] = ''
							form.content[l.code] = {
								blocks: []
							}
							drafts[l.code] = {
								blocks: []
							}
						})
					}

					function copyI18n(source, target, isJson = false) {
						if (!source) return

						// åç«¯å¦‚æœç»™ JSON å­—ç¬¦ä¸²ï¼Œå°½é‡ parse
						if (typeof source === 'string') {
							const s = source.trim()
							if ((s.startsWith('{') && s.endsWith('}')) || (s.startsWith('[') && s.endsWith(']'))) {
								try {
									const parsed = JSON.parse(s)
									if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) source = parsed
								} catch (e) {}
							}
						}

						// æ™®é€šå­—ç¬¦ä¸²
						if (typeof source === 'string' && !isJson) {
							target['zh'] = source
							return
						}

						// i18n å¯¹è±¡
						langs.forEach(l => {
							const code = l.code
							target[code] = (source && source[code] != null) ? source[code] : (isJson ? {
								blocks: []
							} : '')
						})
					}

					async function openEditModal(item) {
						editId.value = item ? item.id : null
						isPreviewMode.value = false
						currentLang.value = 'zh'
						prevLang.value = 'zh'
						lastSavedTime.value = ''

						await destroyEditor()
						resetFormAndDrafts()

						if (item) {
							const {
								data,
								error
							} = await fetchDetail(item.id)
							if (error) {
								alert('è¯»å–å¤±è´¥ï¼š' + error.message)
							} else if (data) {
								form.sort = data.sort
								form.published = data.published
								form.date = data.date

								if (currentTab.value === 'blog') {
									form.cover = data.cover || ''
									form.showCover = data.showCover === 0 ? 0 : 1
									form.slug = data.slug || ''
									form.read_time = data.read_time || 5

									copyI18n(data.title, form.title)
									copyI18n(data.category, form.category)
									copyI18n(data.excerpt, form.excerpt)
									copyI18n(data.content, form.content, true)
								} else {
									form.cover = data.thumbnail || ''
									copyI18n(data.title, form.title)
									copyI18n(data.type, form.type)
									copyI18n(data.description, form.content, true)
								}

								// å…œåº•ï¼šç¡®ä¿éƒ½æ˜¯ {blocks:[]}
								langs.forEach(l => {
									form.content[l.code] = normalizeEditorData(form.content[l.code])
									drafts[l.code] = normalizeEditorData(deepClone(form.content[l.code]))
								})
							}
						}

						syncCategorySelection()

						// å»ºç«‹å¿«ç…§
						lastSavedSnapshot = snapshot()
						isDirty.value = false

						showModal.value = true
						nextTick(() => {
							const c = document.getElementById('editor-container')
							if (c) c.scrollTop = 0
							initEditor()
						})
					}

					async function confirmClose() {
						// é€€å‡ºå‰æŠŠå½“å‰è¯­è¨€è½ç›˜
						if (editor && !isPreviewMode.value) {
							await saveEditorToDraft(currentLang.value)
							loadDraftToForm(currentLang.value)
						}
						recomputeDirty()

						// ä½ è¦å¼ºæç¤ºå°±å–æ¶ˆæ³¨é‡Š
						// if (isDirty.value) {
						//   const ok = confirm('æ£€æµ‹åˆ°æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šæ”¾å¼ƒå¹¶é€€å‡ºå—ï¼Ÿ')
						//   if (!ok) return
						// }

						await destroyEditor()
						showModal.value = false
					}

					// ===== å¯¼å‡ºæ¸…æ´—ï¼ˆå»é‡ image/video ç©º urlï¼‰=====
					function exportEditorDataForPublic(d) {
						d = normalizeEditorData(d)
						const out = {
							...d,
							blocks: []
						}
						const seen = new Set() // `${type}|${url}`

						const pushUnique = (type, data) => {
							const url = (data?.file?.url || "").trim()
							const key = `${type}|${url}`
							if (url && seen.has(key)) return
							if (url) seen.add(key)
							out.blocks.push({
								type,
								data
							})
						}

						for (const b of (d.blocks || [])) {
							if (!b?.type) continue
							if (b.type === 'video' || b.type === 'image') {
								const url = (b.data?.file?.url || '').trim()
								if (!url) continue
								pushUnique(b.type, {
									...b.data,
									file: {
										...(b.data?.file || {}),
										url
									}
								})
								continue
							}
							out.blocks.push(b)
						}
						return out
					}

					async function saveData() {
						saving.value = true
						const table = currentTab.value

						try {
							// 1) å½“å‰è¯­è¨€ editor -> drafts
							if (editor && !isPreviewMode.value) await saveEditorToDraft(currentLang.value)

							// 2) drafts -> form.contentï¼ˆå››è¯­åŒæ­¥ï¼‰
							langs.forEach(l => loadDraftToForm(l.code))

							// 3) å¯¼å‡ºæ¸…æ´—
							const exportedContent = {}
							langs.forEach(l => {
								const code = l.code
								exportedContent[code] = exportEditorDataForPublic(normalizeEditorData(form
									.content[code]))
							})

							// 4) payload
							let payload = {
								sort: Number(form.sort || 0),
								published: !!form.published,
								date: form.date,
								title: deepClone(form.title),
							}

							if (table === 'blog') {
								Object.assign(payload, {
									cover: form.cover || '',
									showCover: form.showCover ? 1 : 0,
									slug: (form.slug && String(form.slug).trim()) ? form.slug :
										`post-${Date.now()}`,
									read_time: Number(form.read_time || 5),
									content: exportedContent,
									category: deepClone(form.category),
									excerpt: deepClone(form.excerpt),
								})
							} else {
								Object.assign(payload, {
									thumbnail: form.cover || '',
									type: deepClone(form.type),
									description: exportedContent,
								})
							}

							payload = deepClone(payload)

							const result = editId.value ?
								await supabase.from(table).update(payload).eq('id', editId.value).select() :
								await supabase.from(table).insert(payload).select()

							if (result?.error) {
								alert('ä¿å­˜å¤±è´¥ï¼š\n' + JSON.stringify(result.error, null, 2))
								return
							}

							await fetchList(true)

							lastSavedSnapshot = snapshot()
							isDirty.value = false
							showModal.value = false
						} catch (e) {
							console.error('[SAVE] throw:', e)
							alert('ä¿å­˜æŠ›å¼‚å¸¸ï¼š' + (e?.message || e))
						} finally {
							saving.value = false
						}
					}

					// ===== é¢„è§ˆæ¨¡å¼ =====
					async function generatePreview() {
						// å…ˆè½ç›˜å½“å‰è¯­è¨€ï¼Œå†æŠŠ drafts å…¨åŒæ­¥è¿› form
						if (!isPreviewMode.value && editor) {
							await saveEditorToDraft(currentLang.value)
							langs.forEach(l => loadDraftToForm(l.code))
							// é¢„è§ˆæ—¶ä¹Ÿç”¨å¯¼å‡ºæ¸…æ´—åçš„ data
							langs.forEach(l => {
								form.content[l.code] = exportEditorDataForPublic(form.content[l.code])
							})
						}
						isPreviewMode.value = true
					}

					// ===== Find / Replaceï¼ˆåªä½œç”¨â€œå½“å‰è¯­è¨€â€ï¼‰=====
					const fr = reactive({
						open: false,
						find: '',
						replace: '',
						matchCase: false,
						useRegex: false,
						scope: {
							title: true,
							excerpt: true,
							body: true
						},
						lastCount: 0,
						error: ''
					})

					function openFindReplace() {
						fr.open = true
						fr.error = ''
						fr.lastCount = 0
					}

					function escapeRegExp(str) {
						return String(str).replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
					}

					function buildMatcher() {
						const needle = (fr.find || '')
						if (!needle) return null

						if (fr.useRegex) {
							try {
								return new RegExp(needle, fr.matchCase ? 'g' : 'gi')
							} catch (e) {
								fr.error = 'æ­£åˆ™ä¸åˆæ³•ï¼š' + e.message;
								return null
							}
						}
						return new RegExp(escapeRegExp(needle), fr.matchCase ? 'g' : 'gi')
					}

					function replaceText(text, re) {
						const s = String(text || '')
						if (!s) return {
							text: s,
							count: 0
						}
						let count = 0
						const out = s.replace(re, () => {
							count++;
							return fr.replace
						})
						return {
							text: out,
							count
						}
					}

					function replaceListItems(items, re) {
						if (!Array.isArray(items)) return {
							items,
							count: 0
						}
						let count = 0

						const next = items.map(it => {
							if (typeof it === 'string') {
								const r = replaceText(it, re);
								count += r.count;
								return r.text
							}
							if (it && typeof it === 'object') {
								const obj = {
									...it
								}
								if (typeof obj.content === 'string') {
									const r = replaceText(obj.content, re);
									obj.content = r.text;
									count += r.count
								}
								if (Array.isArray(obj.items)) {
									const r2 = replaceListItems(obj.items, re);
									obj.items = r2.items;
									count += r2.count
								}
								return obj
							}
							return it
						})

						return {
							items: next,
							count
						}
					}

					function replaceInEditorData(data, re) {
						const d = deepClone(data || {
							blocks: []
						})
						if (!d.blocks) d.blocks = []
						let count = 0

						d.blocks = d.blocks.map(b => {
							if (!b || !b.type) return b
							const block = deepClone(b)
							const t = block.type
							const bd = block.data || (block.data = {})

							const rep = (key) => {
								if (typeof bd[key] === 'string') {
									const r = replaceText(bd[key], re)
									bd[key] = r.text
									count += r.count
								}
							}

							if (t === 'header' || t === 'paragraph') rep('text')
							else if (t === 'quote') {
								rep('text');
								rep('caption')
							} else if (t === 'image' || t === 'embed' || t === 'video') rep('caption')
							else if (t === 'code') rep('code') // ä¸æƒ³æ›¿æ¢ä»£ç å°±åˆ æ‰
							else if (t === 'checklist' && Array.isArray(bd.items)) {
								bd.items = bd.items.map(it => {
									const obj = {
										...it
									}
									if (typeof obj.text === 'string') {
										const r = replaceText(obj.text, re);
										obj.text = r.text;
										count += r.count
									}
									return obj
								})
							} else if (t === 'table' && Array.isArray(bd.content)) {
								bd.content = bd.content.map(row => {
									if (!Array.isArray(row)) return row
									return row.map(cell => {
										const r = replaceText(cell, re)
										count += r.count
										return r.text
									})
								})
							} else if (t === 'list' && Array.isArray(bd.items)) {
								const r = replaceListItems(bd.items, re)
								bd.items = r.items
								count += r.count
							}

							block.data = bd
							return block
						})

						return {
							data: d,
							count
						}
					}

					async function applyFindReplace() {
						fr.error = ''
						fr.lastCount = 0
						const re = buildMatcher()
						if (!re) return

						// å…ˆè½ç›˜å½“å‰ editorï¼Œç¡®ä¿æ›¿æ¢çš„æ˜¯æœ€æ–°å†…å®¹
						if (editor && !isPreviewMode.value) {
							await saveEditorToDraft(currentLang.value)
							loadDraftToForm(currentLang.value)
						}

						const lang = currentLang.value
						let total = 0

						if (fr.scope.title) {
							const r = replaceText(form.title?.[lang] || '', re)
							form.title[lang] = r.text
							total += r.count
						}

						if (fr.scope.excerpt && currentTab.value === 'blog') {
							const r = replaceText(form.excerpt?.[lang] || '', re)
							form.excerpt[lang] = r.text
							total += r.count
						}

						if (fr.scope.body) {
							const raw = drafts[lang] || form.content?.[lang] || {
								blocks: []
							}
							const r = replaceInEditorData(raw, re)
							drafts[lang] = normalizeEditorData(r.data)
							loadDraftToForm(lang)
							total += r.count

							// ç¼–è¾‘æ¨¡å¼ï¼šæŠŠæ›¿æ¢åçš„å†…å®¹ render å› editor
							if (editor && !isPreviewMode.value) {
								try {
									await editor.render(deepClone(drafts[lang]))
								} catch (e) {
									await destroyEditor();
									await nextTick();
									initEditor()
								}
							}
						}

						fr.lastCount = total
						recomputeDirty()
					}

					// ===== é¢„è§ˆæ¸²æŸ“å™¨ï¼ˆä½ å·²æœ‰çš„ renderArticleContent åŸæ ·ä¿ç•™å³å¯ï¼‰=====
					function renderArticleContent(contentData) {
						if (!contentData || !contentData.blocks) return '<p class="text-neutral-400 italic">æš‚æ— å†…å®¹.</p>'

						let html = ''
						const content = contentData

						content.blocks.forEach((block, i) => {

							// ---- inline helpers (only inside this forEach) ----
							const esc = (s) =>
								String(s ?? "")
								.replace(/&/g, "&amp;")
								.replace(/</g, "&lt;")
								.replace(/>/g, "&gt;")
								.replace(/"/g, "&quot;")
								.replace(/'/g, "&#39;");

							const text = (s) => {
								let v = esc(s);

								// allow basic inline tags (Editor.js common inline tools)
								v = v
									.replace(/&lt;b&gt;(.*?)&lt;\/b&gt;/g, "<b>$1</b>")
									.replace(/&lt;strong&gt;(.*?)&lt;\/strong&gt;/g,
										"<strong>$1</strong>")
									.replace(/&lt;i&gt;(.*?)&lt;\/i&gt;/g, "<i>$1</i>")
									.replace(/&lt;em&gt;(.*?)&lt;\/em&gt;/g, "<em>$1</em>")
									.replace(/&lt;u&gt;(.*?)&lt;\/u&gt;/g, "<u>$1</u>")
									.replace(/&lt;s&gt;(.*?)&lt;\/s&gt;/g, "<s>$1</s>")
									.replace(/&lt;br\s*\/?&gt;/g, "<br>")
									.replace(/&amp;nbsp;/g, "&nbsp;");

								return v;
							};


							const commonText = "text-neutral-800 dark:text-neutral-200";
							const bodyText =
								"text-[15.5px] sm:text-[16.5px] leading-[1.85] tracking-[0.01em]";
							const blockGap = "mb-6";

							switch (block.type) {
								case "header": {
									const level = Math.min(4, Math.max(2, Number(block.data?.level || 2)));

									// fix #4: first heading no weird top space
									const mt = i === 0 ? "mt-0" : (level === 2 ? "mt-10" : level === 3 ?
										"mt-8" : "mt-6");

									const hClass =
										level === 2 ?
										`${mt} mb-4 text-[22px] sm:text-[26px] leading-[1.25] tracking-[-0.01em] font-semibold` :
										level === 3 ?
										`${mt} mb-3 text-[18px] sm:text-[20px] leading-[1.35] tracking-[-0.008em] font-semibold` :
										`${mt} mb-2 text-[16.5px] sm:text-[17px] leading-[1.45] tracking-[-0.006em] font-semibold`;

									html +=
										`<h${level} class="${commonText} ${hClass}">${text(block.data?.text)}</h${level}>`;
									break;
								}

								case "paragraph": {
									html +=
										`<p class="${commonText} ${bodyText} ${blockGap}">${text(block.data?.text)}</p>`;
									break;
								}

								case "list": {
									const isOrdered = block.data?.style === "ordered";
									const tag = isOrdered ? "ol" : "ul";

									const listWrap =
										"my-6 pl-6 " +
										(isOrdered ? "list-decimal" : "list-disc") +
										" space-y-2";

									const liClass = `${commonText} ${bodyText} leading-[1.75]`;

									const items = Array.isArray(block.data?.items) ? block.data.items : [];

									// fix #1: handle items as string OR object (nested list tool / custom output)
									const normalizeItemText = (it) => {
										if (typeof it === "string") return it;
										if (it && typeof it === "object") {
											// common keys across list tools
											return it.content ?? it.text ?? it.title ?? it.label ?? "";
										}
										return String(it ?? "");
									};

									const listItems = items
										.map((it) => {
											const t = normalizeItemText(it);
											return `<li class="${liClass}">${text(t)}</li>`;
										})
										.join("");

									html += `<${tag} class="${listWrap}">${listItems}</${tag}>`;
									break;
								}

								case "image": {
									const url = block.data?.file?.url ? String(block.data.file.url) : "";
									const cap = block.data?.caption ? text(block.data.caption) : "";

									if (url) {
										html +=
											`<figure class="my-8">` +
											// å®¹å™¨ï¼šé»˜è®¤ 1:1ï¼Œå…ˆå ä½ï¼Œé¿å…æŠ–åŠ¨
											`<div class="img-skel relative w-full overflow-hidden rounded-2xl border border-black/5 dark:border-white/10 shadow-sm bg-neutral-200 dark:bg-neutral-800" style="aspect-ratio: 1 / 1;">` +
											// é±¼éª¨ shimmer
											`<div class="skel-shimmer"></div>` +

											// å›¾ç‰‡ï¼šå…ˆé€æ˜ï¼ŒåŠ è½½å®Œæˆå†æ˜¾ç¤ºï¼›åŒæ—¶æŠŠå®¹å™¨ aspect-ratio æ”¹æˆçœŸå®æ¯”ä¾‹
											`<img
								              src="${esc(url)}"
								              loading="lazy"
								              alt="${cap || "image"}"
								              class="absolute inset-0 w-full h-full object-contain opacity-0 transition-opacity duration-300"
								              onload="
								                const w = this.naturalWidth || 1;
								                const h = this.naturalHeight || 1;
								                const wrap = this.closest('.img-skel');
								                if (wrap) { wrap.style.aspectRatio = w + ' / ' + h; wrap.classList.add('is-loaded'); }
								                this.style.opacity = 1;
								              "
								              onerror="
								                const wrap = this.closest('.img-skel');
								                if (wrap) { wrap.classList.add('is-loaded'); }
								                this.style.opacity = 1;
								              "
								            />` +
											`</div>` +

											(cap ?
												`<figcaption class="mt-3 text-center text-sm md:textbase leading-[1.6] text-neutral-500 dark:text-neutral-400">${cap}</figcaption>` :
												"") +
											`</figure>`;
									}
									break;
								}

								case "quote": {
									const alignment =
										block.data?.alignment === "center" ?
										"text-center" :
										block.data?.alignment === "right" ?
										"text-right" :
										"text-left";

									html += `<blockquote class="my-8 ${alignment}">` +
										`<div class="rounded-2xl border border-black/5 dark:border-white/10 bg-black/[0.03] dark:bg-white/[0.04] px-5 py-4">` +
										`<div class="flex gap-4">` +
										`<span class="text-6xl text-neutral-300 dark:text-neutral-600 font-serif leading-none h-4 -mt-1 select-none">â€œ</span>` +
										`<p class="${commonText} ${bodyText} leading-[1.8] italic mb-0">${text(block.data?.text)}</p>` +
										`</div>` +
										(block.data?.caption ?
											`<div class="mt-2 text-[13px] text-neutral-500 dark:text-neutral-400">${text(block.data.caption)}</div>` :
											"") +
										`</div></blockquote>`;
									break;
								}

								case "code": {
									// fix #2: remove template indent introducing first-line spaces
									// also keep code newlines exactly
									const code = esc(block.data?.code || "");
									html += `<div class="my-8">` +
										`<pre class="rounded-2xl border border-black/5 dark:border-white/10 bg-neutral-50 dark:bg-neutral-900/60 overflow-x-auto p-4">` +
										`<code class="text-[13px] sm:text-[14px] leading-[1.65] font-mono text-neutral-800 dark:text-neutral-200 whitespace-pre">${code}</code>` +
										`</pre></div>`;
									break;
								}

								case "embed": {
									const src = block.data?.embed ? String(block.data.embed) : "";
									if (src) {
										html += `<div class="my-8">` +
											`<div class="aspect-video w-full overflow-hidden rounded-2xl border border-black/5 dark:border-white/10 bg-black">` +
											`<iframe src="${esc(src)}" frameborder="0" allowfullscreen class="w-full h-full"></iframe>` +
											`</div>` +
											(block.data?.caption ?
												`<div class="mt-3 text-center text-[13px] leading-[1.6] text-neutral-500 dark:text-neutral-400">${text(block.data.caption)}</div>` :
												"") +
											`</div>`;
									}
									break;
								}

								case "video": {
									const videoUrl = block.data?.file?.url ? String(block.data.file.url) :
										"";
									if (videoUrl) {
										html += `
										<div class="my-8 flex flex-col w-full justify-center">
										  <div class="video-wrapper w-full md:max-h-[80vh] overflow-hidden rounded-2xl border border-black/5 dark:border-white/10 aspect-video transition-all">
										    <video controls  preload="metadata" class="video-el w-full h-full object-contain"
										      onloadedmetadata="this.closest('.video-wrapper').classList.remove('aspect-video')"
										      <source src="${esc(videoUrl)}" type="video/mp4" />
										      æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾ã€‚
										    </video>
										  </div>
										  ${
										    block.data?.caption
										      ? `<div class="mt-3 text-center text-[13px] leading-[1.6] text-neutral-500 dark:text-neutral-400">
										           ${text(block.data.caption)}
										         </div>`
										      : ""
										  }
										</div>`;
									}
									break;
								}

								case "table": {
									const rows = Array.isArray(block.data?.content) ? block.data.content : [];

									let tableHtml =
										`<div class="my-8 overflow-x-auto">` +
										`<table class="min-w-full border-separate border-spacing-0 rounded-2xl overflow-hidden border border-black/5 dark:border-white/10">`;

									rows.forEach((row, rowIndex) => {
										tableHtml +=
											`<tr class="${rowIndex % 2 === 0 ? "bg-white dark:bg-neutral-900" : "bg-neutral-50 dark:bg-neutral-900/60"}">`;
										(Array.isArray(row) ? row : []).forEach((cell) => {
											tableHtml +=
												`<td class="align-top px-4 py-3 text-[14px] leading-[1.7] ${commonText} border-b border-black/5 dark:border-white/10">${text(cell)}</td>`;
										});
										tableHtml += `</tr>`;
									});

									tableHtml += `</table></div>`;
									html += tableHtml;
									break;
								}

								case "checklist": {
									// fix #3: nicer checked UI
									const items = Array.isArray(block.data?.items) ? block.data.items : [];

									html += `<ul class="my-6 space-y-3">`;

									items.forEach((it) => {
										const checked = !!it?.checked;
										const label = text(it?.text);

										html +=
											`<li class="flex items-center gap-3">` +
											`<span class="mt-[3px] inline-flex h-[18px] w-[18px] shrink-0 items-center justify-center rounded-[6px] border border-black/15 dark:border-white/15 ` +
											(checked ?
												`bg-neutral-900 dark:bg-white text-white dark:text-neutral-900 shadow-sm` :
												`bg-white dark:bg-neutral-900`) +
											`">` +
											(checked ?
												`<span class="text-[12px] flex items-center justify-center leading-none">âˆš</span>` :
												``) +
											`</span>` +
											`<span class="${commonText} ${bodyText} leading-[1.75] ${checked ? "line-through opacity-60" : ""}">${label}</span>` +
											`</li>`;
									});

									html += `</ul>`;
									break;
								}

								case "delimiter": {
									html += `<hr class="my-10 border-black/10 dark:border-white/10" />`;
									break;
								}

								default:
									break;
							}
						});





						// å¤åˆ¶ç»“æŸ

						return html
					}

					function getI18n(obj, lang) {
						if (!obj) return ''
						if (typeof obj === 'string') {
							try {
								if (obj.trim().startsWith('{')) {
									const parsed = JSON.parse(obj)
									return parsed[lang] || parsed['zh'] || ''
								}
							} catch (e) {
								return obj
							}
							return obj
						}
						return obj[lang] || obj['zh'] || ''
					}

					// Ctrl+A
					// å– Editor.js å†…å®¹ï¼ˆå­—ç¬¦ä¸²æˆ– blocks éƒ½è¡Œï¼Œè¿™é‡Œè¿”å›çº¯æ–‡æœ¬æ›´é€‚åˆâ€œå…¨æ–‡å¤åˆ¶â€ï¼‰
					async function getEditorPlainText() {
						if (!editor) return ""
						const data = await editor.save()
						// ä½ ä¹Ÿå¯ä»¥ç›´æ¥ JSON.stringify(data)ï¼Œä½†â€œå…¨æ–‡å…¨é€‰â€æ›´åƒæ˜¯ç»™ä½ è¯»/æ”¹çš„æ–‡æœ¬
						const lines = []
						for (const b of (data.blocks || [])) {
							if (b.type === "paragraph" && b.data?.text) {
								lines.push(b.data.text.replace(/<[^>]+>/g, "")) // ç®€å•å» HTML
							} else if (b.data?.text) {
								lines.push(String(b.data.text).replace(/<[^>]+>/g, ""))
							}
						}
						return lines.join("\n\n")
					}

					async function setEditorFromPlainText(text) {
						if (!editor) return
						// ç®€å•ï¼šæŠŠçº¯æ–‡æœ¬æŒ‰ç©ºè¡Œåˆ‡æˆ paragraph blocks
						const blocks = String(text || "")
							.split(/\n\s*\n/g)
							.map(t => t.trim())
							.filter(Boolean)
							.map(t => ({
								type: "paragraph",
								data: {
									text: t
								}
							}))

						await editor.render({
							time: Date.now(),
							blocks,
							version: "2.30.0"
						})
					}
					async function copyCurrentLangPayload() {
						const lang = currentLang.value

						const payload = {
							tab: currentTab.value, // blog / media
							lang,
							title: form.title?.[lang] || "",
							excerpt: form.excerpt?.[lang] || "",
							// category/type ä¹Ÿå¸¦ä¸Šï¼ˆåªå¸¦å½“å‰è¯­è¨€ï¼‰
							category: currentTab.value === "blog" ? (form.category?.[lang] || "") : undefined,
							type: currentTab.value === "media" ? (form.type?.[lang] || "") : undefined,
							// Editor.js å†…å®¹ï¼šå»ºè®®å­˜å®Œæ•´ dataï¼Œå¤åˆ¶/ç²˜è´´æœ€ç¨³
							content: editor ? await editor.save() : null
						}

						const text = JSON.stringify(payload, null, 2)

						// å†™å‰ªè´´æ¿ï¼ˆHTTPS/localhost æœ€ç¨³ï¼‰
						if (navigator.clipboard?.writeText) {
							await navigator.clipboard.writeText(text)
						} else {
							// fallbackï¼šç”¨ä¸´æ—¶ textarea
							quickSelectText(text)
							document.execCommand("copy")
						}
					}

					async function pasteToCurrentLangPayload() {
						const lang = currentLang.value
						let text = ""

						if (navigator.clipboard?.readText) {
							text = await navigator.clipboard.readText()
						} else {
							alert("å½“å‰ç¯å¢ƒä¸æ”¯æŒè¯»å–å‰ªè´´æ¿ï¼ˆéœ€è¦ https/localhostï¼‰ã€‚")
							return
						}

						let payload
						try {
							payload = JSON.parse(text)
						} catch {
							alert("å‰ªè´´æ¿å†…å®¹ä¸æ˜¯ JSONï¼Œç²˜è´´å¤±è´¥ã€‚")
							return
						}

						// åªè¦†ç›–å½“å‰è¯­è¨€
						if (typeof payload.title === "string") form.title[lang] = payload.title
						if (typeof payload.excerpt === "string") form.excerpt[lang] = payload.excerpt

						if (currentTab.value === "blog" && typeof payload.category === "string") {
							form.category[lang] = payload.category
						}
						if (currentTab.value === "media" && typeof payload.type === "string") {
							form.type[lang] = payload.type
						}

						if (payload.content && editor) {
							// è¿™é‡Œç”¨ Editor.js çš„ data ç›´æ¥ render
							await editor.render(payload.content)
						}

						recomputeDirty()
					}

					function quickSelectText(text) {
						const ta = document.createElement("textarea")
						ta.value = text
						ta.setAttribute("readonly", "readonly")
						ta.style.position = "fixed"
						ta.style.left = "-9999px"
						ta.style.top = "0"
						document.body.appendChild(ta)
						ta.focus()
						ta.select()
						// ç•™ä¸€ç‚¹æ—¶é—´è®©ç”¨æˆ· Ctrl+Cï¼›ä¹Ÿå¯ä»¥ä¸ç§»é™¤
						setTimeout(() => document.body.removeChild(ta), 8000)
					}

					async function selectAllArticleAsText() {
						const lang = currentLang.value
						const title = form.title?.[lang] || ""
						const excerpt = form.excerpt?.[lang] || ""
						const body = await getEditorPlainText()

						const full = [title, excerpt, body].filter(Boolean).join("\n\n")
						quickSelectText(full)
					}
					async function onGlobalKeydown(e) {
						const isMac = /Mac|iPhone|iPad|iPod/i.test(navigator.platform)
						const meta = isMac ? e.metaKey : e.ctrlKey

						// Ctrl/âŒ˜ + A
						if (meta && e.key.toLowerCase() === "a") {
							const el = document.activeElement
							const tag = (el?.tagName || "").toLowerCase()

							// å¦‚æœç„¦ç‚¹åœ¨ input/textareaï¼Œä¿æŒæµè§ˆå™¨é»˜è®¤å…¨é€‰ï¼ˆåˆ«æ‹¦ï¼‰
							if (tag === "input" || tag === "textarea") return

							// å¦‚æœç„¦ç‚¹åœ¨ Editor.js åŒºåŸŸï¼ˆcontenteditableï¼‰
							const inEditor = el && (el.isContentEditable || el.closest?.("#editorjs"))
							if (inEditor) {
								e.preventDefault()
								e.stopPropagation()
								await selectAllArticleAsText()
							}
						}

						// ä½ ä¹Ÿå¯ä»¥é¢å¤–åšï¼šCtrl/âŒ˜+Shift+C å¤åˆ¶å½“å‰è¯­è¨€ JSON
						if (meta && e.shiftKey && e.key.toLowerCase() === "c") {
							e.preventDefault()
							await copyCurrentLangPayload()
						}
					}



					// ===== mounted =====
					onMounted(async () => {
						const {
							data
						} = await supabase.auth.getSession()
						session.value = data.session
						if (session.value) fetchList()
						window.addEventListener("keydown", onGlobalKeydown, true)
					})

					onBeforeUnmount(() => {
						window.removeEventListener("keydown", onGlobalKeydown, true)
					})


					// ===== å¯¹å¤– return =====
					return {
						session,
						email,
						password,
						msg,
						loading,
						login,
						logout,

						currentTab,
						displayList,
						switchTab,
						fetchList,

						showModal,
						saving,
						uploadingCover,
						editId,
						form,

						langs,
						currentLang,
						handleLangSwitch,

						openEditModal,
						confirmClose,
						saveData,
						deleteItem,

						getI18n,
						isPreviewMode,
						generatePreview,
						lastSavedTime,

						tempCategorySelection,
						predefinedOptions,
						handleCategoryChange,

						renderArticleContent,

						lastUploadedUrl,
						showUploadToast,
						copyUrl,
						handleCoverUpload,

						isDirty,

						showMobileMeta,
						mobileMetaMounted,

						fr,
						openFindReplace,
						applyFindReplace,

						showUploadToast,
						copyUrl,
						uploadState,

						pasteToCurrentLangPayload,
						copyCurrentLangPayload,
					}
				}
			}).mount('#app')
		</script>

		<!-- æ›¿æ¢æ‰€æœ‰select -->
		<script>
			(function() {
				const SEL = "select:not([multiple]):not([size])"; // è·³è¿‡å¤šé€‰/size ä¸‹æ‹‰

				const cls = {
					wrap: "relative w-full",
					btn: [
						"w-full flex items-center justify-between gap-2",
						"px-3 py-2 rounded-xl",
						"bg-slate-50 border border-slate-200",
						"text-sm text-slate-800",
						"hover:bg-white hover:border-slate-300",
						"focus:outline-none focus:ring-2 focus:ring-slate-500/30",
						"transition",
					].join(" "),
					label: "truncate",
					labelPlaceholder: "truncate text-slate-400",
					chev: "w-4 h-4 text-slate-400 transition-transform",
					panel: [
						"absolute z-50 mt-2 w-full",
						"bg-white rounded-xl shadow-lg border border-slate-200",
						"max-h-60 overflow-auto py-1",
						"origin-top",
					].join(" "),
					opt: "w-full text-left px-3 py-2 text-sm flex items-center justify-between hover:bg-slate-50 transition",
					optActive: "text-slate-600 font-semibold",
					optNormal: "text-slate-700",
					tick: "text-slate-600",
					hiddenSelect: "sr-only", // Tailwind å†…ç½®
					rotate: "rotate-180",
				};

				function getSelectedLabel(select) {
					const opt = select.selectedOptions?.[0];
					if (!opt) return "";
					return opt.textContent?.trim() || "";
				}

				function getPlaceholderLabel(select) {
					// ä¼˜å…ˆæ‰¾ disabled/ç©ºå€¼ çš„ option å½“ placeholder
					const ph =
						select.querySelector('option[disabled][value=""]') ||
						select.querySelector("option[disabled]") ||
						select.querySelector('option[value=""]');
					return ph?.textContent?.trim() || "è¯·é€‰æ‹©...";
				}

				function closeAll(exceptWrap) {
					document.querySelectorAll("[data-fsel-wrap].is-open").forEach((w) => {
						if (w !== exceptWrap) {
							w.classList.remove("is-open");
							const panel = w.querySelector("[data-fsel-panel]");
							const btn = w.querySelector("[data-fsel-btn]");
							const chev = w.querySelector("[data-fsel-chev]");
							if (panel) panel.classList.add("hidden");
							if (btn) btn.setAttribute("aria-expanded", "false");
							if (chev) chev.classList.remove(cls.rotate);
						}
					});
				}

				function enhanceSelect(select) {
					if (!select || select.dataset.fselEnhanced === "1") return;
					select.dataset.fselEnhanced = "1";

					// åŒ…ä¸€å±‚
					const wrap = document.createElement("div");
					wrap.className = cls.wrap;
					wrap.dataset.fselWrap = "1";

					select.parentNode.insertBefore(wrap, select);
					wrap.appendChild(select);

					// éšè—åŸç”Ÿ selectï¼ˆä½†ä¿ç•™åœ¨ DOMï¼‰
					select.classList.add(...cls.hiddenSelect.split(" "));

					// è§¦å‘æŒ‰é’®
					const btn = document.createElement("button");
					btn.type = "button";
					btn.className = cls.btn;
					btn.dataset.fselBtn = "1";
					btn.setAttribute("aria-haspopup", "listbox");
					btn.setAttribute("aria-expanded", "false");

					const label = document.createElement("span");
					label.className = cls.label;
					label.dataset.fselLabel = "1";

					const chev = document.createElementNS("http://www.w3.org/2000/svg", "svg");
					chev.setAttribute("viewBox", "0 0 24 24");
					chev.setAttribute("fill", "none");
					chev.setAttribute("stroke", "currentColor");
					chev.classList.add(...cls.chev.split(" "));
					chev.dataset.fselChev = "1";
					chev.innerHTML =
						'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';

					btn.appendChild(label);
					btn.appendChild(chev);

					// é¢æ¿
					const panel = document.createElement("div");
					panel.className = cls.panel + " hidden";
					panel.dataset.fselPanel = "1";
					panel.setAttribute("role", "listbox");

					function rebuildOptions() {
						panel.innerHTML = "";

						const placeholder = getPlaceholderLabel(select);
						const hasValue = !!select.value;

						if (!hasValue) {
							label.className = cls.labelPlaceholder;
							label.textContent = placeholder;
						} else {
							label.className = cls.label;
							label.textContent = getSelectedLabel(select) || placeholder;
						}

						[...select.options].forEach((opt) => {
							// è·³è¿‡ disabled placeholder é¡¹ï¼ˆä¸è®©ç‚¹ï¼‰
							if (opt.disabled && (opt.value === "" || opt === select.options[0])) return;

							const item = document.createElement("button");
							item.type = "button";
							item.className = cls.opt + " " + (opt.value === select.value ? cls.optActive : cls
								.optNormal);
							item.textContent = opt.textContent?.trim() || opt.value;
							item.setAttribute("role", "option");
							item.dataset.value = opt.value;

							if (opt.value === select.value) {
								const tick = document.createElement("span");
								tick.className = cls.tick;
								tick.textContent = "âœ“";
								item.appendChild(tick);
							}

							item.addEventListener("click", () => {
								select.value = opt.value;

								// âœ… è§¦å‘åŸç”Ÿ changeï¼Œè®© v-model / ç›‘å¬ç»§ç»­å·¥ä½œ
								select.dispatchEvent(new Event("change", {
									bubbles: true
								}));
								select.dispatchEvent(new Event("input", {
									bubbles: true
								}));

								// å…³æ‰é¢æ¿
								wrap.classList.remove("is-open");
								panel.classList.add("hidden");
								btn.setAttribute("aria-expanded", "false");
								chev.classList.remove(cls.rotate);

								rebuildOptions();
							});

							panel.appendChild(item);
						});
					}

					rebuildOptions();

					// ç‚¹å‡»æŒ‰é’®å¼€å…³
					btn.addEventListener("click", (e) => {
						e.preventDefault();
						const isOpen = wrap.classList.contains("is-open");
						closeAll(wrap);

						if (isOpen) {
							wrap.classList.remove("is-open");
							panel.classList.add("hidden");
							btn.setAttribute("aria-expanded", "false");
							chev.classList.remove(cls.rotate);
						} else {
							wrap.classList.add("is-open");
							panel.classList.remove("hidden");
							btn.setAttribute("aria-expanded", "true");
							chev.classList.add(cls.rotate);
						}
					});

					// åŸç”Ÿ select è¢«ç¨‹åºæ”¹å€¼æ—¶ï¼ŒåŒæ­¥ UI
					select.addEventListener("change", rebuildOptions);

					// æ’å…¥
					wrap.appendChild(btn);
					wrap.appendChild(panel);

					// å¤–éƒ¨ç‚¹å‡»å…³é—­
					document.addEventListener("mousedown", (ev) => {
						if (!wrap.contains(ev.target)) {
							wrap.classList.remove("is-open");
							panel.classList.add("hidden");
							btn.setAttribute("aria-expanded", "false");
							chev.classList.remove(cls.rotate);
						}
					});

					// ç›‘å¬ option åŠ¨æ€å˜åŒ–ï¼ˆæ¯”å¦‚ä½ åˆ‡è¯­è¨€ã€é‡æ–°æ¸²æŸ“ optionï¼‰
					const mo = new MutationObserver(rebuildOptions);
					mo.observe(select, {
						childList: true,
						subtree: true,
						attributes: true
					});
				}

				function enhanceAll() {
					document.querySelectorAll(SEL).forEach(enhanceSelect);
				}

				// é¦–æ¬¡å¢å¼º
				enhanceAll();

				// âœ… å¦‚æœä½ é¡µé¢ä¼šåŠ¨æ€æ’å…¥ selectï¼ˆVue æ¡ä»¶æ¸²æŸ“/åˆ—è¡¨åˆ‡æ¢ï¼‰ï¼Œè‡ªåŠ¨å¢å¼ºæ–°å‡ºç°çš„
				const pageMO = new MutationObserver(() => enhanceAll());
				pageMO.observe(document.documentElement, {
					childList: true,
					subtree: true
				});

				// æš´éœ²ä¸€ä¸ªæ‰‹åŠ¨è§¦å‘å£ï¼ˆå¯é€‰ï¼‰
				window.enhanceAllSelects = enhanceAll;
			})();
		</script>

	</body>
</html>