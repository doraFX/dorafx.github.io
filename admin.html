<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>作品管理</title>
		<!-- 引入 CSS -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
		<style>
			#dropZone {
				background-color: #f8f9fa;
				border: 2px dashed #adb5bd;
				border-radius: 5px;
				padding: 20px;
				text-align: center;
				cursor: pointer;
			}

			#imageDropZone {
				background-color: #f8f9fa;
				border: 2px dashed #adb5bd;
				border-radius: 5px;
				padding: 20px;
				text-align: center;
				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<!-- 导航栏 -->
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">作品管理</a>
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
					aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarNav">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<button class="btn btn-primary" id="saveBtn">保存JSON</button>
						</li>
						<li class="nav-item">
							<button class="btn btn-secondary ms-2" id="importBtn">导入JSON</button>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- 表格区域 -->
		<div class="container mt-3">
			<button class="btn btn-success mb-3" id="addBtn">添加新作品</button>
			<table id="worksTable" class="table table-striped table-bordered">
				<thead>
					<tr>
						<th>ID</th>
						<th>标题</th>
						<th>类别</th>
						<th>描述</th>
						<th>推荐</th>
						<th>媒体类型</th>
						<th>媒体URL</th>
						<th>封面</th>
						<th>操作</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</div>

		<!-- 编辑/添加模态框 -->
		<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="editModalLabel">编辑作品</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="editForm">
							<input type="hidden" id="editId">
							<div class="mb-3">
								<label for="editTitle" class="form-label">标题</label>
								<input type="text" class="form-control" id="editTitle" required>
							</div>
							<div class="mb-3">
								<label for="editCategory" class="form-label">类别</label>
								<select class="form-select" id="editCategory">
									<option value="2D">2D</option>
									<option value="3D">3D</option>
									<option value="Video">视频</option>
									<option value="Web">网页</option>
								</select>
							</div>
							<div class="mb-3">
								<label for="editDescription" class="form-label">描述</label>
								<textarea class="form-control" id="editDescription" rows="3"></textarea>
							</div>
							<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="editRecommend">
								<label class="form-check-label" for="editRecommend">推荐</label>
							</div>
							<div class="mb-3">
								<label for="editMediaType" class="form-label">媒体类型</label>
								<select class="form-select" id="editMediaType">
									<option value="blog">博文</option>
									<option value="video">视频</option>
									<option value="image">图片</option>
								</select>
							</div>
							<!-- 博文字段 -->
							<div id="blog-fields" style="display: none;">
								<label class="form-label">博文内容</label>
								<div id="editor-container"></div>
							</div>
							<!-- 视频字段 -->
							<div id="video-fields" style="display: none;">
								<label for="editVideoUrl" class="form-label">视频 URL</label>
								<input type="text" class="form-control" id="editVideoUrl" placeholder="请输入视频链接">
								<label class="form-label mt-3">封面（Poster）</label>
								<input type="file" id="poster-upload" accept="image/*">
								<div id="dropZone" class="mt-2">拖拽图片到这里</div>
							</div>
							<!-- 图片字段 -->
							<div id="image-fields" style="display: none;">
								<label class="form-label">上传图片</label>
								<input type="file" id="image-upload" accept="image/*">
								<div id="imageDropZone" class="mt-2">拖拽图片到这里</div>
							</div>
							<div class="mb-3">
								<label class="form-label">链接</label>
								<div id="linksContainer"></div>
								<button type="button" class="btn btn-sm btn-secondary" id="addLinkBtn">添加链接</button>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" id="saveEditBtn">保存</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 引入 JS -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
		<script>
			let table;
			let quill = new Quill('#editor-container', {
				theme: 'snow'
			});

			// 初始化 DataTables
			$(document).ready(function() {
				table = $('#worksTable').DataTable({
					columns: [{
							data: 'id'
						},
						{
							data: 'title'
						},
						{
							data: 'category'
						},
						{
							data: 'description'
						},
						{
							data: 'recommend',
							render: data => data ? '是' : '否'
						},
						{
							data: 'media.type'
						},
						{
							data: 'media.url'
						},
						{
							data: 'media.poster'
						},
						{
							data: null,
							render: () => '<button class="btn btn-sm btn-primary editBtn">编辑</button> ' +
								'<button class="btn btn-sm btn-danger deleteBtn">删除</button>'
						}
					]
				});
				loadData(); // 初始化空数据

				// 动态显示表单字段
				document.getElementById('editMediaType').addEventListener('change', function() {
					const type = this.value;
					document.getElementById('blog-fields').style.display = type === 'blog' ? 'block' : 'none';
					document.getElementById('video-fields').style.display = type === 'video' ? 'block' : 'none';
					document.getElementById('image-fields').style.display = type === 'image' ? 'block' : 'none';
				});
			});

			// 加载数据
			function loadData(file) {
				if (file) {
					const reader = new FileReader();
					reader.onload = function(e) {
						try {
							const works = JSON.parse(e.target.result);
							table.clear().rows.add(works).draw();
						} catch (error) {
							Swal.fire('错误', '无法解析JSON文件', 'error');
						}
					};
					reader.readAsText(file);
				} else {
					const works = [];
					table.clear().rows.add(works).draw();
				}
			}

			// 导入 JSON
			$('#importBtn').on('click', function() {
				const input = document.createElement('input');
				input.type = 'file';
				input.accept = '.json';
				input.onchange = function(event) {
					const file = event.target.files[0];
					if (file) loadData(file);
				};
				input.click();
			});

			// 保存 JSON
			$('#saveBtn').on('click', function() {
				const data = table.rows().data().toArray();
				const json = JSON.stringify(data, null, 2);
				const blob = new Blob([json], {
					type: 'application/json'
				});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'portfolio.json';
				a.click();
				URL.revokeObjectURL(url);
			});

			// 添加新作品
			$('#addBtn').on('click', function() {
				$('#editId').val('');
				$('#editTitle').val('');
				$('#editCategory').val('2D');
				$('#editDescription').val('');
				$('#editRecommend').prop('checked', false);
				$('#editMediaType').val('image');
				$('#linksContainer').empty();
				quill.root.innerHTML = '';
				document.getElementById('blog-fields').style.display = 'none';
				document.getElementById('video-fields').style.display = 'none';
				document.getElementById('image-fields').style.display = 'block';
				$('#editModal').modal('show');
			});

			// 编辑作品
			$('#worksTable tbody').on('click', '.editBtn', function() {
				const row = table.row($(this).parents('tr')).data();
				$('#editId').val(row.id);
				$('#editTitle').val(row.title);
				$('#editCategory').val(row.category);
				$('#editDescription').val(row.description);
				$('#editRecommend').prop('checked', row.recommend);
				$('#editMediaType').val(row.media.type);
				$('#linksContainer').empty();
				row.links.forEach(link => addLinkField(link.name, link.url));
				if (row.media.type === 'blog') {
					quill.root.innerHTML = row.content || '';
					document.getElementById('blog-fields').style.display = 'block';
					document.getElementById('video-fields').style.display = 'none';
					document.getElementById('image-fields').style.display = 'none';
				} else if (row.media.type === 'video') {
					document.getElementById('editVideoUrl').value = row.media.url || '';
					document.getElementById('blog-fields').style.display = 'none';
					document.getElementById('video-fields').style.display = 'block';
					document.getElementById('image-fields').style.display = 'none';
				} else {
					document.getElementById('blog-fields').style.display = 'none';
					document.getElementById('video-fields').style.display = 'none';
					document.getElementById('image-fields').style.display = 'block';
				}
				$('#editModal').modal('show');
			});

			// 删除作品
			$('#worksTable tbody').on('click', '.deleteBtn', function() {
				const row = table.row($(this).parents('tr'));
				Swal.fire({
					title: '确定删除?',
					text: '删除后无法恢复',
					icon: 'warning',
					showCancelButton: true,
					confirmButtonText: '删除',
					cancelButtonText: '取消'
				}).then(result => {
					if (result.isConfirmed) {
						row.remove().draw();
						Swal.fire('已删除', '', 'success');
					}
				});
			});

			// 添加链接字段
			function addLinkField(name = '', url = '') {
				const linkHtml = `
                <div class="input-group mb-2">
                    <input type="text" class="form-control" placeholder="名称" value="${name}">
                    <input type="text" class="form-control" placeholder="URL" value="${url}">
                    <button type="button" class="btn btn-danger removeLinkBtn">删除</button>
                </div>
            `;
				$('#linksContainer').append(linkHtml);
			}

			$('#addLinkBtn').on('click', () => addLinkField());

			$('#linksContainer').on('click', '.removeLinkBtn', function() {
				$(this).parent().remove();
			});

			// 保存编辑或新增
			$('#saveEditBtn').on('click', function() {
				const id = $('#editId').val();
				const type = $('#editMediaType').val();
				const newWork = {
					id: id ? parseInt(id) : (Math.max(...table.rows().data().toArray().map(row => row.id), 0) + 1) ||
						1,
					title: $('#editTitle').val(),
					category: $('#editCategory').val(),
					description: $('#editDescription').val(),
					recommend: $('#editRecommend').prop('checked'),
					media: {
						type: type
					},
					links: []
				};

				if (type === 'blog') {
					newWork.content = quill.root.innerHTML;
				} else if (type === 'video') {
					newWork.media.url = $('#editVideoUrl').val();
					const posterFile = document.getElementById('poster-upload').files[0];
					newWork.media.poster = posterFile ? `./images/works/${posterFile.name}` : '';
				} else if (type === 'image') {
					const imageFile = document.getElementById('image-upload').files[0];
					const path = imageFile ? `./images/works/${imageFile.name}` : '';
					newWork.media.url = path;
					newWork.media.poster = path;
				}

				$('#linksContainer .input-group').each(function() {
					const name = $(this).find('input:eq(0)').val();
					const url = $(this).find('input:eq(1)').val();
					if (name && url) newWork.links.push({
						name,
						url
					});
				});

				if (id) {
					const rowIndex = table.rows().data().toArray().findIndex(row => row.id == id);
					if (rowIndex !== -1) table.row(rowIndex).data(newWork).draw();
				} else {
					table.row.add(newWork).draw();
				}
				$('#editModal').modal('hide');
			});

			// 拖拽上传逻辑
			$('#editModal').on('shown.bs.modal', function() {
				// 图片类型的拖拽区域
				const imageDropZone = document.getElementById('imageDropZone');
				if (imageDropZone) {
					imageDropZone.addEventListener('dragover', e => {
						e.preventDefault();
						imageDropZone.style.backgroundColor = '#e9ecef';
					});
					imageDropZone.addEventListener('dragleave', e => {
						e.preventDefault();
						imageDropZone.style.backgroundColor = '';
					});
					imageDropZone.addEventListener('drop', e => {
						e.preventDefault();
						imageDropZone.style.backgroundColor = '';
						const file = e.dataTransfer.files[0];
						if (file && file.type.startsWith('image/')) {
							const fileName = file.name;
							const path = `./images/works/${fileName}`;
							document.getElementById('image-upload').files = e.dataTransfer.files;
							Swal.fire('提示', `请确保将图片 "${fileName}" 放置在 images/works/ 目录下`, 'info');
						} else {
							Swal.fire('错误', '请拖拽一个图片文件', 'error');
						}
					});
				}

				// 视频封面的拖拽区域
				const dropZone = document.getElementById('dropZone');
				if (dropZone) {
					dropZone.addEventListener('dragover', e => {
						e.preventDefault();
						dropZone.style.backgroundColor = '#e9ecef';
					});
					dropZone.addEventListener('dragleave', e => {
						e.preventDefault();
						dropZone.style.backgroundColor = '';
					});
					dropZone.addEventListener('drop', e => {
						e.preventDefault();
						dropZone.style.backgroundColor = '';
						const file = e.dataTransfer.files[0];
						if (file && file.type.startsWith('image/')) {
							const fileName = file.name;
							const path = `./images/works/${fileName}`;
							document.getElementById('poster-upload').files = e.dataTransfer.files;
							Swal.fire('提示', `请确保将图片 "${fileName}" 放置在 images/works/ 目录下`, 'info');
						} else {
							Swal.fire('错误', '请拖拽一个图片文件', 'error');
						}
					});
				}
			});
		</script>
	</body>
</html>