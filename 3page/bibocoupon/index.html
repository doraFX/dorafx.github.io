<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>å“”å•µ~ é¡½åŠ£å…”ä¸“å±é¢†åˆ¸ä¸­å¿ƒ</title>
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
		<script src="https://cdn.tailwindcss.com"></script>
		<link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
		<style>
			:root {
				--primary-pink: #ff9ead;
				--dark-pink: #db2777;
				--bg-cream: #fffaf0;
			}

			body {
				background-color: var(--bg-cream);
				font-family: 'ZCOOL KuaiLe', cursive, sans-serif;
				user-select: none;
				-webkit-tap-highlight-color: transparent;
				overflow: hidden;
				/* é”å®šæ ¹éƒ¨ï¼Œç¦æ­¢ä»»ä½•æ»šåŠ¨æŠ–åŠ¨ */
				position: fixed;
				/* å½»åº•é”å®šç§»åŠ¨ç«¯è§†å£ */
				width: 100%;
				height: 100%;
			}

			/* ä¼˜æƒ åˆ¸é€ å‹ */
			.coupon-card {
				position: relative;
				background: white;
				border: 4px solid var(--primary-pink);
				border-radius: 24px;
			}

			.coupon-card::before,
			.coupon-card::after {
				content: '';
				position: absolute;
				top: 70%;
				width: 30px;
				height: 30px;
				background-color: var(--bg-cream);
				border: 4px solid var(--primary-pink);
				border-radius: 50%;
				z-index: 10;
			}

			.coupon-card::before {
				left: -19px;
			}

			.coupon-card::after {
				right: -19px;
			}

			/* è¿‡æœŸæ ·å¼ */
			.expired {
				filter: grayscale(100%);
				opacity: 0.6;
				pointer-events: none;
			}

			/* å…”å­è€³æœµè£…é¥° */
			.bunny-ear {
				width: 40px;
				height: 60px;
				background: #ffb7c5;
				border: 3px solid #333;
				border-radius: 50% 50% 50% 50% / 80% 80% 20% 20%;
				display: inline-block;
			}

			/* --- æ ¸å¿ƒï¼šå¼ºåŠ›åé¦ˆæŒ‰é’® --- */
			.bibo-btn-fancy {
				position: relative;
				width: 140px;
				height: 140px;
				background: linear-gradient(145deg, #ff5e9e, #ff4d8d);
				border-radius: 50%;
				color: white;
				font-size: 1.8rem;
				font-weight: bold;
				border: 6px solid #fff;
				display: flex;
				align-items: center;
				justify-content: center;
				box-shadow: 0 12px 0 0 var(--dark-pink), 0 20px 30px rgba(219, 39, 119, 0.3);
				/* å›å¼¹åŠ¨ç”» */
				transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
				outline: none;
			}

			/* æŒ‰ä¸‹ç¬é—´çš„ç‰©ç†æŒ¤å‹æ„Ÿ */
			.bibo-btn-fancy:active {
				transform: translateY(10px) scale(1.05, 0.9);
				box-shadow: 0 2px 0 0 var(--dark-pink), 0 5px 10px rgba(219, 39, 119, 0.2);
				background: #f43f5e;
				transition: all 0.05s;
			}

			/* ç¦ç”¨æ€ï¼šçœ‹èµ·æ¥è¢«æŒ‰ä¸‹å» + ä¸èƒ½ç‚¹ */
			.bibo-disabled {
				cursor: not-allowed;
				opacity: 0.75;
				transform: translateY(10px) scale(1.05, 0.9);
				box-shadow: 0 2px 0 0 var(--dark-pink), 0 5px 10px rgba(219, 39, 119, 0.18);
				background: linear-gradient(145deg, #fb7185, #f43f5e);
				filter: saturate(0.9);
			}

			/* disabled æœ¬èº«ä¹Ÿåˆ«å†è§¦å‘ active æ•ˆæœ */
			.bibo-btn-fancy:disabled:active {
				transform: translateY(10px) scale(1.05, 0.9);
			}

			/* å…”å­å‚ç›´è·³è·ƒï¼Œä¸å ç”¨æ–‡æ¡£æµé«˜åº¦ */
			.rabbit-jump {
				display: inline-block;
				/* transition: transform 0.15s cubic-bezier(0.22, 0.61, 0.36, 1); */

				transition: transform 0.22s cubic-bezier(0.22, 0.61, 0.36, 1);
				will-change: transform;
			}

			.is-pressing-rabbit {
				transform: translateY(-55px) scale(1.15);
			}

			/* Toast æ°”æ³¡åŠ¨æ•ˆ */
			.toast-enter-active,
			.toast-leave-active {
				transition: all 0.2s ease-out;
			}

			.toast-enter-from,
			.toast-leave-to {
				opacity: 0;
				transform: translateY(10px);
			}

			/* å·²é¢†å–å°ç«  */
			.stamp {
				border: 4px double #ff9ead;
				color: #ff9ead;
				font-weight: bold;
				padding: 2px 8px;
				border-radius: 4px;
				transform: rotate(-15deg);
			}
		</style>
	</head>
	<body>
		<div id="app" class="max-w-md mx-auto h-full relative flex flex-col overflow-hidden">

			<!-- æµ®å±‚ Toast -->
			<transition name="toast">
				<div v-if="toast.show"
					class="fixed top-12 left-0 right-0 z-[100] flex justify-center pointer-events-none">
					<div
						class="bg-pink-500 text-white px-8 py-3 rounded-full shadow-2xl border-2 border-white text-sm font-bold">
						{{ toast.msg }} ğŸ°
					</div>
				</div>
			</transition>

			<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
			<nav class="flex justify-around py-6 bg-white/70 backdrop-blur-md border-b border-pink-100 z-40 shrink-0">
				<div @click="switchView('collect')"
					:class="view === 'collect' ? 'text-pink-600 scale-110' : 'text-gray-400'"
					class="cursor-pointer transition-all font-bold">é¢†åˆ¸ä¸­å¿ƒ</div>
				<div @click="switchView('history')"
					:class="view === 'history' ? 'text-pink-600 scale-110' : 'text-gray-400'"
					class="cursor-pointer transition-all font-bold">æˆ‘çš„å£è¢‹</div>
			</nav>

			<!-- ä¸»ä½“å±•ç¤ºåŒº (å›ºå®šé«˜åº¦å¹¶æ”¯æŒæ»šåŠ¨) -->
			<div class="flex-grow overflow-y-auto">

				<!-- 1. é¢†åˆ¸å±•ç¤º -->
				<div v-if="view === 'collect'" class="p-6 flex flex-col items-center">
					<div class="flex -space-x-2 mb-2 mt-8">
						<div class="bunny-ear -rotate-12"></div>
						<div class="bunny-ear rotate-12"></div>
					</div>
					<h1 class="text-3xl text-pink-500 mb-8">é¡½åŠ£å…”è¡¥ç»™ç«™</h1>

					<div class="coupon-card w-full p-8 shadow-xl bg-white relative">
						<div v-if="hasClaimedCurrent" class="absolute top-4 right-4 stamp">å·²å…¥è¢‹</div>
						<div class="text-pink-300 text-xs tracking-widest mb-3 italic">LIMITED OFFER</div>
						<h2 class="text-2xl text-gray-800 mb-4">{{ currentCoupon.title }}</h2>
						<p class="text-gray-500 text-sm leading-relaxed mb-10 h-12">{{ currentCoupon.desc }}</p>

						<div class="border-t-2 border-dashed border-pink-100 pt-6">
							<p class="text-pink-400 text-xs mb-6 text-center">ğŸ“… {{ displayDate }}</p>
							<button v-if="!hasClaimedCurrent" @click="collectCoupon"
								class="w-full py-4 bg-pink-400 text-white rounded-2xl shadow-lg active:scale-95 transition-all font-bold text-lg">
								ç«‹åˆ»é¢†èµ° ğŸ¾
							</button>
							<button v-else @click="switchView('history')"
								class="w-full py-4 bg-gray-50 text-pink-300 rounded-2xl border border-gray-100 font-bold">
								å·²åœ¨å£è¢‹é‡Œï¼Œå»çœ‹çœ‹
							</button>
						</div>
					</div>
				</div>

				<!-- 2. å†å²åˆ—è¡¨ -->
				<div v-if="view === 'history'" class="p-6">
					<h2 class="text-xl text-pink-500 mb-8 font-bold flex items-center">
						<span class="mr-2 text-2xl">ğŸ’</span> æˆ‘çš„å…¨éƒ¨å¡åˆ¸
					</h2>
					<div v-if="myCoupons.length === 0" class="text-center py-20 text-gray-300">ç›®å‰å£è¢‹ç©ºç©º ğŸ¥•</div>
					<div v-for="item in myCoupons" :key="item.id"
						class="coupon-card p-5 mb-6 shadow-sm flex justify-between items-center bg-white"
						:class="{ 'expired': checkExpired(item.endTime) }">
						<div>
							<h3 class="font-bold text-gray-700 text-lg">{{ item.title }}</h3>
							<p class="text-[11px] text-gray-400 mt-1">
								{{ item.startTime === item.endTime ? item.startTime + ' å½“æ—¥æœ‰æ•ˆ' : item.startTime + ' è‡³ ' + item.endTime }}
							</p>
						</div>
						<button v-if="!checkExpired(item.endTime)" @click="useCoupon(item)"
							class="bg-pink-400 text-white px-5 py-2 rounded-full text-xs font-bold shadow-md active:scale-90 transition-transform">
							å»ä½¿ç”¨
						</button>
						<span v-else class="text-gray-400 text-sm font-bold italic mr-2">å·²è¿‡æœŸ</span>
					</div>
				</div>
			</div>

			<!-- 3. ä½¿ç”¨è¯¦æƒ…é¡µ (å…¨å±æµ®å±‚) -->
			<transition name="toast">
				<div v-if="view === 'use'" class="fixed inset-0 bg-pink-50 z-50 flex flex-col items-center">
					<!-- è¿”å›æŒ‰é’®åŒº -->
					<div class="w-full p-6 shrink-0 z-50">
						<div @click="goBack"
							class="inline-flex items-center text-pink-400 text-xl font-bold cursor-pointer px-4 py-2 -ml-4 active:opacity-50 transition-opacity">
							<span class="text-3xl mr-1" style="margin-top:-4px">â€¹</span> è¿”å›
						</div>
					</div>

					<!-- äº’åŠ¨äº¤äº’åŒº -->
					<div class="flex-grow flex flex-col items-center justify-center -mt-20 w-full overflow-hidden">
						<!-- å…”å­ï¼šå›ºå®šå ä½å®¹å™¨ -->
						<div class="h-48 flex items-end justify-center w-full">
							<!-- <div class="text-[130px] rabbit-jump" :class="{ 'is-pressing-rabbit': isPressing }">ğŸ°</div> -->
							<img class="rabbit-jump w-[140px] h-[140px] object-contain select-none"
								:class="{ 'is-pressing-rabbit': isPressing }" :src="currentFrameSrc" alt="rabbit" />

						</div>

						<!-- æ°”æ³¡æç¤ºï¼šå›ºå®šå ä½å®¹å™¨ -->
						<div class="h-20 mt-2 flex items-center justify-center w-full">
							<transition name="toast">
								<div v-if="isPressing"
									class="bg-white px-8 py-2 rounded-full border-2 border-pink-300 text-pink-500 font-bold shadow-lg">
									BIBO! BIBO!
								</div>
							</transition>
						</div>

						<!-- æ ¸å¿ƒæŒ‰é’®ï¼šä½ç½®ç»å¯¹å›ºå®š -->
						<div class="mt-6">
							<button @click="triggerBibo" :disabled="isPlaying" class="bibo-btn-fancy"
								:class="{ 'bibo-disabled': isPlaying }">
								{{ isPlaying ? 'å“”å•µä¸­â€¦' : 'å“”å•µ' }}
							</button>

						</div>

						<p class="mt-12 text-pink-300 text-sm tracking-[0.3em] opacity-60">é¡½åŠ£å…”ç‰¹æƒæ‰§è¡Œä¸­</p>
					</div>
					<!-- éŸ³é¢‘ -->
					<audio id="audioPlayer" src="bibo.mp3" preload="auto"></audio>
				</div>
			</transition>

		</div>

		<script>
			const {
				createApp,
				ref,
				computed,
				onMounted
			} = Vue;

			createApp({
				setup() {
					const view = ref('collect');
					const myCoupons = ref([]);
					const isPressing = ref(false);
					const toast = ref({
						show: false,
						msg: ''
					});
					const isPlaying = ref(false);

					const frames = {
						// ä½ çš„å¸§æ•°é‡ï¼ˆæ”¹æˆå®é™…æ•°é‡ï¼‰
						biboCount: 29,
						// å¸§æ–‡ä»¶å¤¹
						dir: 'frames',
						// å‰ç¼€
						biboPrefix: 'bibo12fps_',
						// æ‰©å±•åï¼špng æˆ– webp
						ext: 'webp',
						// é™æ­¢å¸§ï¼ˆé€šå¸¸ 0ï¼‰
						idleIndex: 0,
					};

					const FrameCache = {
						loaded: false,
						list: [],
						loadingPromise: null,
					};

					const preloadFramesOnce = (frames) => {
						if (FrameCache.loaded) return Promise.resolve(FrameCache.list);
						if (FrameCache.loadingPromise) return FrameCache.loadingPromise;

						FrameCache.loadingPromise = new Promise((resolve, reject) => {
							const arr = [];
							let done = 0;
							const total = frames.biboCount;

							for (let i = 0; i < total; i++) {
								const img = new Image();
								const n = String(i).padStart(3, '0');
								img.src = `${frames.dir}/${frames.biboPrefix}${n}.${frames.ext}`;

								img.onload = async () => {
									// å…³é”®ï¼šæå‰ decodeï¼Œé¿å…æ’­æ”¾æ—¶è§£ç å¡é¡¿ï¼ˆæ”¯æŒçš„æµè§ˆå™¨æ›´ç¨³ï¼‰
									if (img.decode) {
										try {
											await img.decode();
										} catch {}
									}
									done++;
									if (done === total) {
										FrameCache.loaded = true;
										FrameCache.list = arr;
										resolve(arr);
									}
								};
								img.onerror = (e) => reject(e);

								arr.push(img);
							}
						});

						return FrameCache.loadingPromise;
					};

					const frameIndex = ref(frames.idleIndex);
					const currentFrameSrc = computed(() => {
						const img = FrameCache.list[frameIndex.value];
						if (img) return img.src;
						const n = String(frames.idleIndex).padStart(3, '0');
						return `${frames.dir}/${frames.biboPrefix}${n}.${frames.ext}`;
					});

					// --- é™æ€é…ç½® ---
					const currentCoupon = {
						id: "BIBO_2026_0109",
						title: "å“”å•µé™æ—¶åˆ¸",
						desc: "å…è®¸é¡½åŠ£å…”å‡­æ­¤åˆ¸â€œå“”å•µâ€â€œå“”å•µâ€åœ°å«ã€‚æŒ‰ä¸€ä¸‹å«ä¸€å£°ï¼Œä¸æŒ‰ä¸å‡†å«ã€‚",
						startTime: "2026-01-09",
						endTime: "2026-01-09"
					};

					// æ ¸å¿ƒé€»è¾‘ï¼šåˆ‡æ¢è§†å›¾å¹¶å¤„ç†å†å²è®°å½•
					const switchView = (newView) => {
						if (view.value === newView) return;

						if (newView === 'use') {
							// âœ… è¿›å…¥ useï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å†å²è®°å½•ï¼Œä¿è¯å¯å›é€€
							history.pushState({
								page: 'use'
							}, '');
							view.value = 'use';
							return;
						}

						// âœ… åˆ‡æ¢ collect/historyï¼šåªæ›´æ–°â€œå½“å‰ entryâ€ï¼Œä¸é¢å¤–å¢åŠ å†å²è®°å½•
						view.value = newView;
						history.replaceState({
							page: newView
						}, '');
					};


					// æ ¸å¿ƒé€»è¾‘ï¼šè¿”å›æŒ‰é’®
					const goBack = () => {
						if (view.value === 'use') {
							history.back(); // è§¦å‘ popstate -> æŒ‰ state å›åˆ° history/collect
							return;
						}
						view.value = 'history';
						history.replaceState({
							page: 'history'
						}, '');
					};


					onMounted(() => {
						// è¯»å–å­˜å‚¨
						const saved = localStorage.getItem('rabbit_coupons_v3');
						if (saved) myCoupons.value = JSON.parse(saved);

						// âœ… å…³é”®ï¼šç»™å½“å‰é¡µé¢å†™ä¸€ä¸ªâ€œåˆå§‹ stateâ€ï¼Œå¦åˆ™ back å¯èƒ½ç›´æ¥é€€å‡ºé¡µé¢æˆ–ä¸è§¦å‘ä½ æƒ³è¦çš„é€»è¾‘
						if (!history.state || !history.state.page) {
							history.replaceState({
								page: view.value
							}, '');
						}

						// âœ… å¤„ç†æµè§ˆå™¨/æ‰‹æœºè¿”å›é”®ï¼šæŒ‰ state è¿˜åŸé¡µé¢
						window.addEventListener('popstate', (event) => {
							const page = event.state?.page;

							// æ²¡æœ‰ state çš„æƒ…å†µï¼ˆæŸäº›ç¯å¢ƒä¼šå‡ºç°ï¼‰ï¼Œç»™ä¸€ä¸ªå®‰å…¨å›è½
							if (!page) {
								view.value = 'history';
								history.replaceState({
									page: 'history'
								}, '');
								return;
							}

							view.value = page;
						});
					});


					const hasClaimedCurrent = computed(() => myCoupons.value.some(c => c.id === currentCoupon.id));
					const displayDate = computed(() => {
						const {
							startTime,
							endTime
						} = currentCoupon;
						return startTime === endTime ? `${startTime} å½“æ—¥æœ‰æ•ˆ` : `${startTime} è‡³ ${endTime}`;
					});

					const showToast = (msg) => {
						toast.value.msg = msg;
						toast.value.show = true;
						setTimeout(() => {
							toast.value.show = false
						}, 2000);
					};

					const collectCoupon = () => {
						if (hasClaimedCurrent.value) return;
						myCoupons.value.unshift({
							...currentCoupon,
							claimTime: Date.now()
						});
						localStorage.setItem('rabbit_coupons_v3', JSON.stringify(myCoupons.value));
						showToast('é¢†å–æˆåŠŸï¼è¯·æ”¶å¥½å“¦');
						setTimeout(() => {
							switchView('history')
						}, 1000);
					};

					const checkExpired = (endTimeStr) => {
						const today = new Date();
						today.setHours(0, 0, 0, 0);
						const end = new Date(endTimeStr);
						end.setHours(0, 0, 0, 0);
						return today > end;
					};

					const useCoupon = async (item) => {
						if (checkExpired(item.endTime)) return showToast('è¿™å¼ åˆ¸å·²ç»è¿‡æœŸå•¦');

						try {
							// å…ˆåŠ è½½å¸§ï¼ˆåªä¼šåŠ è½½ä¸€æ¬¡ï¼‰
							showToast('è£…è½½å…”å…”ä¸­â€¦');
							await preloadFramesOnce(frames);

							// å†è¿› use é¡µ
							switchView('use');
						} catch (e) {
							console.warn(e);
							showToast('å…”å…”å¸§åŠ è½½å¤±è´¥ï¼ˆæ£€æŸ¥è·¯å¾„/è·¨åŸŸ/æ–‡ä»¶åï¼‰');
						}
					};


					const playBibo = (e) => {
						isPressing.value = true;
						const audio = document.getElementById('audioPlayer');
						if (audio) {
							audio.currentTime = 0;
							audio.play().catch(() => {
								// å¤„ç†ç§»åŠ¨ç«¯é¦–åˆ·æœªäº¤äº’ä¸æ’­éŸ³çš„é—®é¢˜
								console.warn("Audio play blocked or failed");
							});
						}
						if (navigator.vibrate) navigator.vibrate(15);
					};

					let rafId = 0;

					// æ ¹æ®éŸ³é¢‘æ’­æ”¾è¿›åº¦æ¨è¿›å¸§ï¼ˆçœŸæ­£åŒæ­¥ï¼‰
					const startFrameAnim = (audio) => {
						cancelAnimationFrame(rafId);

						// ä»¥å½“å‰éŸ³é¢‘æ—¶é—´ä¸ºèµ·ç‚¹ï¼ˆå¦‚æœä½ å…è®¸ä¸­é€”æ’­æ”¾ä¹Ÿç¨³ï¼‰
						const total = frames.biboCount;

						const tick = () => {
							if (!isPlaying.value) return;

							// ç”¨çœŸå®éŸ³é¢‘è¿›åº¦é©±åŠ¨åŠ¨ç”»
							const t = audio.currentTime || 0; // ç§’
							const dur = (audio.duration && isFinite(audio.duration)) ? audio.duration : 0;

							if (dur > 0) {
								const progress = Math.min(t / dur, 1);
								const idx = Math.floor(progress * (total - 1));
								frameIndex.value = Math.max(0, Math.min(total - 1, idx));
							} else {
								// duration è¿˜æ²¡å‡ºæ¥æ—¶ï¼Œå…ˆä¿æŒåœ¨ç¬¬ 0 å¸§ï¼ˆé¿å…ä¹±è·³ï¼‰
								frameIndex.value = 0;
							}

							rafId = requestAnimationFrame(tick);
						};

						rafId = requestAnimationFrame(tick);
					};

					const stopFrameAnim = () => {
						cancelAnimationFrame(rafId);
					};


					const resetToIdle = () => {
						stopFrameAnim();
						frameIndex.value = frames.idleIndex;
					};

					const triggerBibo = async () => {
						if (isPlaying.value) return;

						const audio = document.getElementById('audioPlayer');
						if (!audio) return;

						isPlaying.value = true;
						isPressing.value = true;

						// æ¸…ç†æ—§çš„ endedï¼ˆé¿å…å¤šæ¬¡ç»‘å®šå åŠ ï¼‰
						audio.onended = null;

						// éŸ³é¢‘ç»“æŸï¼šå› idle + è§£é”
						audio.onended = () => {
							resetToIdle();
							isPressing.value = false;
							isPlaying.value = false;
						};

						try {
							// ä»å¤´æ’­
							audio.currentTime = 0;

							// æ³¨æ„ï¼šå®‰å“è¿™é‡Œâ€œå£°éŸ³çœŸæ­£å‡ºæ¥â€ä¼šæœ‰å»¶è¿Ÿ
							// ä½†æˆ‘ä»¬åŠ¨ç”»æ˜¯ç”¨ audio.currentTime é©±åŠ¨ -> å¤©ç”ŸåŒæ­¥
							await audio.play();

							// ä¸€å¼€å§‹æŠŠå¸§ç½® 0ï¼ˆèµ·è·³ï¼‰
							frameIndex.value = 0;

							// å¼€å§‹ï¼šç”¨ audio.currentTime é©±åŠ¨åŠ¨ç”»
							startFrameAnim(audio);

							if (navigator.vibrate) navigator.vibrate(15);
						} catch (e) {
							resetToIdle();
							isPressing.value = false;
							isPlaying.value = false;
							showToast('æ’­æ”¾å¤±è´¥ï¼šæ£€æŸ¥ bibo.mp3 æˆ–æµè§ˆå™¨æƒé™');
							console.warn(e);
						}
					};


					return {
						view,
						currentCoupon,
						myCoupons,
						hasClaimedCurrent,
						displayDate,
						toast,
						isPressing,
						isPlaying,
						currentFrameSrc,

						switchView,
						goBack,
						collectCoupon,
						checkExpired,
						useCoupon,
						triggerBibo,
					};
				}
			}).mount('#app');
		</script>
	</body>
</html>